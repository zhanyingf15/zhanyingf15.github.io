
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="忘语的个人博客">
    <title>elasticserch-sql和mybatis整合记录 - 忘语的个人博客</title>
    <meta name="author" content="忘语">
    
    
        <link rel="icon" href="https://zhanyingf15.github.io/assets/images/favicon.png">
    
    
    <meta name="description" content="说明elasticearch即es本身没有JDBC驱动，是无法像mybatis管理数据库连接池进行数据库操作的。在GitHub上有个elasticsearch-sql的项目，作为es的插件后能够使用sql对es进行数据检索，项目提供了一个支持JDBC的实验特性，在druid的基础上实现了部分JDBC的功能。GitHub上目前仅给出了一个使用用例

2017-8-12修改：重写了该项目，分离了Dr">
<meta property="og:type" content="blog">
<meta property="og:title" content="elasticserch-sql和mybatis整合记录">
<meta property="og:url" content="https://zhanyingf15.github.io/2017/07/15/elasticserch-sql和mybatis整合记录/index.html">
<meta property="og:site_name" content="忘语的个人博客">
<meta property="og:description" content="说明elasticearch即es本身没有JDBC驱动，是无法像mybatis管理数据库连接池进行数据库操作的。在GitHub上有个elasticsearch-sql的项目，作为es的插件后能够使用sql对es进行数据检索，项目提供了一个支持JDBC的实验特性，在druid的基础上实现了部分JDBC的功能。GitHub上目前仅给出了一个使用用例

2017-8-12修改：重写了该项目，分离了Dr">
<meta property="og:updated_time" content="2017-08-18T10:28:46.647Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="elasticserch-sql和mybatis整合记录">
<meta name="twitter:description" content="说明elasticearch即es本身没有JDBC驱动，是无法像mybatis管理数据库连接池进行数据库操作的。在GitHub上有个elasticsearch-sql的项目，作为es的插件后能够使用sql对es进行数据检索，项目提供了一个支持JDBC的实验特性，在druid的基础上实现了部分JDBC的功能。GitHub上目前仅给出了一个使用用例

2017-8-12修改：重写了该项目，分离了Dr">
    
    
        
    
    
        <meta property="og:image" content="https://zhanyingf15.github.io/assets/images/me.jpg"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-nuvue6sithwirecbhvw3dkaobiojqvtadsnhguwi7k04xklybw5djl1smadp.min.css">
    <!--STYLES END-->
    
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="3">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/ ">忘语的个人博客</a>
    </h1>
    
        
            <a  class="header-right-picture "
                href="#about">
        
        
            <img class="header-picture" src="/assets/images/me.jpg"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="3">
    
        <div class="sidebar-profile">
            <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/me.jpg"/>
            </a>
            <span class="sidebar-profile-name">忘语</span>
        </div>
    
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/ "
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">首页</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-categories"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                    <span class="sidebar-button-desc">分类</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-tags"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">标签</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-archives"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
                    <span class="sidebar-button-desc">归档</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="#about"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-question"></i>
                    <span class="sidebar-button-desc">关于</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://github.com/zhanyingf15" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-github"></i>
                    <span class="sidebar-button-desc">GitHub</span>
                </a>
        </li>
        
    </ul>
    
</nav>

            
            <div id="main" data-behavior="3"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title" itemprop="headline">
            elasticserch-sql和mybatis整合记录
        </h1>
    
    <div class="post-meta">
    <time itemprop="datePublished" datetime="2017-07-15T18:03:00+08:00">
	
		    7月 15, 2017
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/大数据/">大数据</a>, <a class="category-link" href="/categories/大数据/elasticsearch/">elasticsearch</a>


    
</div>

</div>
    
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            <h1 id="table-of-contents">目录</h1><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#说明"><span class="toc-text">说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#druid和elasticsearch-sql梳理"><span class="toc-text">druid和elasticsearch-sql梳理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#流程"><span class="toc-text">流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mybatis查询过程梳理"><span class="toc-text">Mybatis查询过程梳理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#流程-1"><span class="toc-text">流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#总结-1"><span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#elasticsearch和mybatis整合"><span class="toc-text">elasticsearch和mybatis整合</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#说明-1"><span class="toc-text">说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#构造元数据信息"><span class="toc-text">构造元数据信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#重写物理连接的创建方法"><span class="toc-text">重写物理连接的创建方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#重写DruidPooledPreparedStatement中execute和setXXX方法"><span class="toc-text">重写DruidPooledPreparedStatement中execute和setXXX方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#重写ElasticSearchConnection中prepareStatement创建，resultSet获取和资源释放等方法"><span class="toc-text">重写ElasticSearchConnection中prepareStatement创建，resultSet获取和资源释放等方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#修改ElasticSearchDruidPooledConnection-java"><span class="toc-text">修改ElasticSearchDruidPooledConnection.java</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#其它修改"><span class="toc-text">其它修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建datasrouce-es-xml并import到apppicationContext-xml"><span class="toc-text">创建datasrouce-es.xml并import到apppicationContext.xml</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#关于分页查询"><span class="toc-text">关于分页查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ElasticsearchServiceBase-java"><span class="toc-text">ElasticsearchServiceBase.java</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ElasticsearchPaginationInterceptor-java"><span class="toc-text">ElasticsearchPaginationInterceptor.java</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sql支持"><span class="toc-text">sql支持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#maven依赖"><span class="toc-text">maven依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#后续"><span class="toc-text">后续</span></a></li></ol>
<h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><p>elasticearch即es本身没有JDBC驱动，是无法像mybatis管理数据库连接池进行数据库操作的。在<a href="https://github.com/NLPchina/elasticsearch-sql" target="_blank" rel="external">GitHub</a>上有个elasticsearch-sql的项目，作为es的插件后能够使用sql对es进行数据检索，项目提供了一个支持JDBC的实验特性，在druid的基础上实现了部分JDBC的功能。GitHub上目前仅给出了一个使用用例</p>
<blockquote>
<p>2017-8-12修改：<br>重写了该项目，分离了Druid连接池，不再限制使用Druid，添加了Driver，项目已共享至GitHub <a href="https://github.com/zhanyingf15/elasticsearch-jdbc" target="_blank" rel="external">elasticsearch-jdbc</a>，欢迎fork</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Properties properties = <span class="keyword">new</span> Properties();</div><div class="line">properties.put(<span class="string">"url"</span>, <span class="string">"jdbc:elasticsearch://192.168.70.128:9300/"</span>);</div><div class="line">DruidDataSource dds = (DruidDataSource) ElasticSearchDruidDataSourceFactory.createDataSource(properties);</div><div class="line">Connection connection = dds.getConnection();</div><div class="line">PreparedStatement ps = connection.prepareStatement(<span class="string">"SELECT  * from  radiott"</span>);</div><div class="line">ResultSet resultSet = ps.executeQuery();</div><div class="line">List&lt;String&gt; result = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line"><span class="keyword">while</span> (resultSet.next()) &#123;</div><div class="line">    System.out.println(resultSet.getString(<span class="string">"id"</span>) + <span class="string">","</span> + resultSet.getString(<span class="string">"name"</span>));</div><div class="line">&#125;</div><div class="line">ps.close();</div><div class="line">connection.close();</div><div class="line">dds.close();</div></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="druid和elasticsearch-sql梳理"><a href="#druid和elasticsearch-sql梳理" class="headerlink" title="druid和elasticsearch-sql梳理"></a>druid和elasticsearch-sql梳理</h3><h4 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h4><blockquote>
<p><em>主要是在Druid连接池上进行了继承改造，实现了部分JDBC规范</em></p>
</blockquote>
<ol>
<li>DruidDataSource dds = (DruidDataSource) ElasticSearchDruidDataSourceFactory.createDataSource(properties);</li>
</ol>
<p>创建一个继承自DruidDataSource的ElasticSearchDruidDataSource类，重写创建物理连接的代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">// init connections</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, size = getInitialSize(); i &lt; size; ++i) &#123;</div><div class="line">        Connection conn = createPhysicalConnection();</div><div class="line">        DruidConnectionHolder holder = <span class="keyword">new</span> DruidConnectionHolder(<span class="keyword">this</span>, conn);</div><div class="line">        connections[poolingCount] = holder;</div><div class="line">        incrementPoolingCount();</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Connection <span class="title">createPhysicalConnection</span><span class="params">(String url, Properties info)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    Connection conn = <span class="keyword">new</span> ElasticSearchConnection(url);</div><div class="line">    createCount.incrementAndGet();</div><div class="line">    <span class="keyword">return</span> conn;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ElasticSearchConnection继承自Connection接口，在构造方法中实现client的实例化，创建一个es的客户端。重写prepareStatement方法，返回一个PreparedStatement接口的空实现。因为prepareStatement返回的是PreparedStatement的空实现，所以并没有PreparedStatement的实际功能，仅仅是为了符合JDBC的规范。所有操作都是通过client完成。</p>
<ol>
<li>Connection connection = dds.getConnection();</li>
</ol>
<p>重写创建内部连接getConnectionInternal的代码，在druid初始化时创建初始连接时，在内部就是调用的getConnectionInternal方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> DruidPooledConnection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    <span class="keyword">return</span> getConnection(maxWait);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> DruidPooledConnection <span class="title">getConnection</span><span class="params">(<span class="keyword">long</span> maxWaitMillis)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    init();</div><div class="line">    <span class="keyword">return</span> getConnectionDirect(maxWaitMillis);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> DruidPooledConnection <span class="title">getConnectionDirect</span><span class="params">(<span class="keyword">long</span> maxWaitMillis)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    ...</div><div class="line">    poolableConnection = getConnectionInternal(maxWaitMillis);</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> DruidPooledConnection <span class="title">getConnectionInternal</span><span class="params">(<span class="keyword">long</span> maxWait)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    ...</div><div class="line">    DruidConnectionHolder holder;</div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> (maxWait &gt; <span class="number">0</span>) &#123;</div><div class="line">        holder = pollLast(nanos);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        holder = takeLast();</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    DruidPooledConnection poolalbeConnection = <span class="keyword">new</span> ElasticSearchDruidPooledConnection(holder);</div><div class="line">    <span class="keyword">return</span> poolalbeConnection;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>DruidPooledConnection是一个很重要的类，它保存在DruidDataSource属性connections数组中，在连接池初始化时或后续通过createPhysicalConnection方法创建的真实连接就保存在<br>DruidPooledConnection实例的conn属性中。</p>
<p>通过holder创建一个DruidPooledConnection poolalbeConnection = new ElasticSearchDruidPooledConnection(holder)示例，我们通过getConnection()方法获取到的连接就是poolalbeConnection实例。==DruidConnectionHolder的实例holder保存在DruidPooledConnection实例的holder属性中==。在DruidPooledConnection的构造函数中，执行了一次this.conn = holder.getConnection();即把holder保存的==实际物理连接Connection实例保存在DruidPooledConnection的conn属性中==。</p>
<ol>
<li>PreparedStatement ps = connection.prepareStatement(“SELECT  * from  radiott”);</li>
</ol>
<p>创建一个继承自DruidPooledConnection的类ElasticSearchDruidPooledConnection，重写prepareStatement方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> PreparedStatement <span class="title">prepareStatement</span><span class="params">(String sql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    checkState();</div><div class="line">    PreparedStatementHolder stmtHolder = <span class="keyword">null</span>;</div><div class="line">    DruidPooledPreparedStatement.PreparedStatementKey key = <span class="keyword">new</span> DruidPooledPreparedStatement.PreparedStatementKey(sql, getCatalog(), PreparedStatementPool.MethodType.M1);</div><div class="line">    <span class="keyword">boolean</span> poolPreparedStatements = holder.isPoolPreparedStatements();</div><div class="line">    <span class="keyword">if</span> (poolPreparedStatements) &#123;</div><div class="line">        stmtHolder = holder.getStatementPool().get(key);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (stmtHolder == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            stmtHolder = <span class="keyword">new</span> PreparedStatementHolder(key, conn.prepareStatement(sql));</div><div class="line">            holder.getDataSource().incrementPreparedStatementCount();</div><div class="line">        &#125; <span class="keyword">catch</span> (SQLException ex) &#123;</div><div class="line">            handleException(ex);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    initStatement(stmtHolder);</div><div class="line">    DruidPooledPreparedStatement rtnVal = <span class="keyword">new</span> ElasticSearchDruidPooledPreparedStatement(<span class="keyword">this</span>, stmtHolder);</div><div class="line">    holder.addTrace(rtnVal);</div><div class="line">    <span class="keyword">return</span> rtnVal;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>方法中创建了一个很重要的实例stmtHolder = new PreparedStatementHolder(key, conn.prepareStatement(sql))。==该实例作为参数传入ElasticSearchDruidPooledPreparedStatement的构造函数中最后保存在DruidPooledPreparedStatement的属性holder中==。</p>
<p>这个stmtHolder在和mybatis整合的过程中相当重要，它保存了当前连接中的statement（<em>通过conn.prepareStatement(sql)创建</em>），在这个statement中，有几个重要的方法getResultSet()、getUpdateCount()、getMoreResults()，mybatis最后在理结果时会调用。</p>
<p>最后，将创建的DruidPooledPreparedStatement实例rtnVal保存在holder(DruidConnectionHolder的实例)中，返回rtnVal。</p>
<ol>
<li>ResultSet resultSet = ps.executeQuery();</li>
</ol>
<p>创建一个继承自DruidPooledPreparedStatement的类ElasticSearchDruidPooledPreparedStatement，重写构造方法和executeQuery方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">Client client = <span class="keyword">null</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ElasticSearchDruidPooledPreparedStatement</span><span class="params">(DruidPooledConnection conn, PreparedStatementHolder holder)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    <span class="keyword">super</span>(conn, holder);</div><div class="line">    <span class="keyword">this</span>.client = ((ElasticSearchConnection) conn.getConnection()).getClient();</div><div class="line">&#125;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ResultSet <span class="title">executeQuery</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        ObjectResult extractor = getObjectResult(<span class="keyword">true</span>, getSql(), <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line">        List&lt;String&gt; headers = extractor.getHeaders();</div><div class="line">        List&lt;List&lt;Object&gt;&gt; lines = extractor.getLines();</div><div class="line">        ResultSet rs = <span class="keyword">new</span> ElasticSearchResultSet(<span class="keyword">this</span>, headers, lines);</div><div class="line">        <span class="keyword">if</span> (rs == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        DruidPooledResultSet poolableResultSet = <span class="keyword">new</span> DruidPooledResultSet(<span class="keyword">this</span>, rs);</div><div class="line">        addResultSetTrace(poolableResultSet);</div><div class="line">        <span class="keyword">return</span> poolableResultSet;</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">        <span class="keyword">throw</span> checkException(t);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        conn.afterExecute();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> ObjectResult <span class="title">getObjectResult</span><span class="params">(<span class="keyword">boolean</span> flat, String query, <span class="keyword">boolean</span> includeScore, <span class="keyword">boolean</span> includeType, <span class="keyword">boolean</span> includeId)</span> <span class="keyword">throws</span> SqlParseException, SQLFeatureNotSupportedException, Exception, CsvExtractorException </span>&#123;</div><div class="line">    SearchDao searchDao = <span class="keyword">new</span> org.nlpcn.es4sql.SearchDao(client);</div><div class="line">    <span class="comment">//String rewriteSQL = searchDao.explain(getSql()).explain().explain();</span></div><div class="line">    QueryAction queryAction = searchDao.explain(query);</div><div class="line">    Object execution = QueryActionElasticExecutor.executeAnyAction(searchDao.getClient(), queryAction);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ObjectResultsExtractor(includeScore, includeType, includeId).extractResults(execution, flat);</div><div class="line">&#125;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">executeUpdate</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="string">"executeUpdate not support in ElasticSearch"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在构造函数中取得实际物理连接Connection实例的自定义es客户端client。在自定义方法getObjectResult中连接es返回实际的数据。</p>
<p>重写executeQuery方法，在获得实际的es数据后，包装成ResultSet对象并返回，供外部遍历用。</p>
<p>executeQuery中有一个非常重要的类ElasticSearchResultSet，该类实现ResultSet接口并实现了next()、getMetaData()和几个getXXX()方法，该类是一个普通类，内部用iterator和current表示数据集和当前遍历的数据。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticSearchResultSet</span> <span class="keyword">implements</span> <span class="title">ResultSet</span> </span>&#123;</div><div class="line">    Iterator&lt;List&lt;Object&gt;&gt; iterator;</div><div class="line">    List&lt;Object&gt; current = <span class="keyword">null</span>;</div><div class="line">    List&lt;String&gt; headers = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">private</span> ResultSetMetaData metaData;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ElasticSearchResultSet</span><span class="params">(Statement statement, <span class="keyword">final</span> List&lt;String&gt; headers, <span class="keyword">final</span> List&lt;List&lt;Object&gt;&gt; lines)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.iterator = lines.iterator();</div><div class="line">        <span class="keyword">this</span>.headers = headers;</div><div class="line">        metaData = <span class="keyword">new</span> ElasticSearchResultSetMetaDataBase(headers);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">next</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">boolean</span> hasNext = iterator.hasNext();</div><div class="line">        <span class="keyword">if</span> (hasNext) &#123;</div><div class="line">            current = iterator.next();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> hasNext;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ResultSetMetaData <span class="title">getMetaData</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">return</span> metaData;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">(<span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">return</span> (String) current.get(columnIndex);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在ElasticSearchResultSet 内部，构造了一个ElasticSearchResultSetMetaDataBase实例作为数据集的元数据。该类继承自ResultSetMetaDataBase类。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticSearchResultSetMetaDataBase</span> <span class="keyword">extends</span> <span class="title">ResultSetMetaDataBase</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ColumnMetaData&gt; columns = <span class="keyword">new</span> ArrayList&lt;ColumnMetaData&gt;();</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ElasticSearchResultSetMetaDataBase</span><span class="params">(List&lt;String&gt; headers)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span>(String column:headers)&#123;</div><div class="line">            ColumnMetaData columnMetaData = <span class="keyword">new</span> ColumnMetaData();</div><div class="line">            columnMetaData.setColumnLabel(column);</div><div class="line">            columnMetaData.setColumnName(column);</div><div class="line">            columns.add(columnMetaData);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p><em>tip:数据列的信息保存在columns属性中，该属性作为ElasticSearchResultSetMetaDataBase的私有属性但未提供相关的访问方法，在最后和mybatis整合过程中mybatis是读取不到resultset的元数据信息的，整合的时候需要改。</em></p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ol>
<li>由连接池负责创建实际的物理连接==ElasticSearchConnection实例connection==   ==》return conn</li>
<li>连接池创建==DruidConnectionHolder实例connHolder==,用conn属性保存第一步创建的connection,将自身实例connHolder保存在连接池的connections数组中</li>
<li>执行getConnection方法，在内部调用方法getConnectionInternal，从连接池connections中取得connHolder创建==DruidPooledConnection实例pooledConnection==，将connHolder保存在pooledConnection的holder属性中，将connHolder保存的connection取出保存在pooledConnection的conn属性中  ==》 return pooledConnection</li>
<li>执行pooledConnection的prepareStatement方法，在方法执行过程中，执行conn.prepareStatement(sql)方法获得==Statement实例stmt==,用stmt做入参创建==PreparedStatementHolder实例stmtHolder==，将stmt实例保存在statement属性中。用pooledConnection和stmtHolder做入参创建==DruidPooledPreparedStatement实例rtnVal==，将pooledConnection保存在rtnVal的conn属性中，stmtHolder保存在holder属性中，从stmtHolder取出statement保存在stmt属性中  ==》rtnVal</li>
<li>执行DruidPooledPreparedStatement实例rtnVal方法executeQuery方法获得resultSet结果集。</li>
<li>遍历结果集获取数据。</li>
</ol>
</blockquote>
<h3 id="Mybatis查询过程梳理"><a href="#Mybatis查询过程梳理" class="headerlink" title="Mybatis查询过程梳理"></a>Mybatis查询过程梳理</h3><h4 id="流程-1"><a href="#流程-1" class="headerlink" title="流程"></a>流程</h4><p>执行session.selectList(xxx,xxx)=&gt;…=&gt;defaultSqlsession.selectList(xxx)=&gt;…=&gt;BaseExcutor.query()=&gt;BaseExcutor.queryFromDatabase()=&gt;…=&gt;SimpleExecutor.doQuery=&gt;执行拦截器=&gt;RoutingStatementHandler.query()=&gt;PreparedStatementHandler.query()<br>在PreparedStatementHandler.query()中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(Statement statement, ResultHandler resultHandler)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    PreparedStatement ps = (PreparedStatement) statement;</div><div class="line">    ps.execute();   <span class="comment">//执行sql操作</span></div><div class="line">    <span class="keyword">return</span> resultSetHandler.&lt;E&gt; handleResultSets(ps);   <span class="comment">//处理结果</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>sql操作</p>
<blockquote>
<p>ps.execute()=&gt;DruidPooledPreparedStatement.execute()=&gt;…jdbc驱动执行sql从数据库取数据等操作….=&gt;层层返回到execute()</p>
</blockquote>
<p>处理结果</p>
<blockquote>
<p>resultSetHandler.<e> handleResultSets(ps)=&gt;DefaultResultSetHandler.handleResultSets(Statement stmt)</e></p>
</blockquote>
<p><em>DefaultResultSetHandler.java</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">handleResultSets</span><span class="params">(Statement stmt)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    ErrorContext.instance().activity(<span class="string">"handling results"</span>).object(mappedStatement.getId());</div><div class="line">    <span class="keyword">final</span> List&lt;Object&gt; multipleResults = <span class="keyword">new</span> ArrayList&lt;Object&gt;();</div><div class="line">    <span class="keyword">int</span> resultSetCount = <span class="number">0</span>;</div><div class="line">    ResultSetWrapper rsw = getFirstResultSet(stmt);  <span class="comment">//获取结果集并处理结果元数据</span></div><div class="line">    List&lt;ResultMap&gt; resultMaps = mappedStatement.getResultMaps();</div><div class="line">    <span class="keyword">int</span> resultMapCount = resultMaps.size();</div><div class="line">    validateResultMapsCount(rsw, resultMapCount);</div><div class="line">    <span class="keyword">while</span> (rsw != <span class="keyword">null</span> &amp;&amp; resultMapCount &gt; resultSetCount) &#123;</div><div class="line">      ResultMap resultMap = resultMaps.get(resultSetCount);</div><div class="line">      handleResultSet(rsw, resultMap, multipleResults, <span class="keyword">null</span>);</div><div class="line">      rsw = getNextResultSet(stmt);</div><div class="line">      cleanUpAfterHandlingResultSet();</div><div class="line">      resultSetCount++;</div><div class="line">    &#125;</div><div class="line">    String[] resultSets = mappedStatement.getResulSets();</div><div class="line">    <span class="keyword">if</span> (resultSets != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">while</span> (rsw != <span class="keyword">null</span> &amp;&amp; resultSetCount &lt; resultSets.length) &#123;</div><div class="line">        ResultMapping parentMapping = nextResultMaps.get(resultSets[resultSetCount]);</div><div class="line">        <span class="keyword">if</span> (parentMapping != <span class="keyword">null</span>) &#123;</div><div class="line">          String nestedResultMapId = parentMapping.getNestedResultMapId();</div><div class="line">          ResultMap resultMap = configuration.getResultMap(nestedResultMapId);</div><div class="line">          handleResultSet(rsw, resultMap, <span class="keyword">null</span>, parentMapping);</div><div class="line">        &#125;</div><div class="line">        rsw = getNextResultSet(stmt);</div><div class="line">        cleanUpAfterHandlingResultSet();</div><div class="line">        resultSetCount++;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> collapseSingleResultList(multipleResults);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>在上面方法中继续执行(DefaultResultSetHandler类中)</p>
<blockquote>
<p>ResultSetWrapper rsw = getFirstResultSet(stmt)=&gt;DefaultResultSetHandler.getFirstResultSet()<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ResultSetWrapper <span class="title">getFirstResultSet</span><span class="params">(Statement stmt)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    ResultSet rs = stmt.getResultSet(); <span class="comment">//获取结果集</span></div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> rs != <span class="keyword">null</span> ? <span class="keyword">new</span> ResultSetWrapper(rs, configuration) : <span class="keyword">null</span>;  <span class="comment">//包装结果集并返回</span></div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>ResultSet rs = stmt.getResultSet()=&gt;DruidStatement.getResultSet()=&gt;ResultSet rs = stmt.getResultSet()=&gt;进入到Connection实例，执行通过prepareStatement方法创建的statement实例中的getResultSet()方法取得resultSet结果集。</p>
</blockquote>
<p>返回到上面代码中ResultSet rs = stmt.getResultSet()结果,执行下一步</p>
<blockquote>
<p>new ResultSetWrapper(rs, configuration)=&gt;ResultSetWrapper构造方法</p>
</blockquote>
<p><em>ResultSetWrapper.java</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ResultSetWrapper</span><span class="params">(ResultSet rs, Configuration configuration)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    <span class="keyword">super</span>();</div><div class="line">    <span class="keyword">this</span>.typeHandlerRegistry = configuration.getTypeHandlerRegistry();</div><div class="line">    <span class="keyword">this</span>.resultSet = rs;</div><div class="line">    <span class="keyword">final</span> ResultSetMetaData metaData = rs.getMetaData();</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> columnCount = metaData.getColumnCount();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= columnCount; i++) &#123;</div><div class="line">      columnNames.add(configuration.isUseColumnLabel() ? metaData.getColumnLabel(i) : metaData.getColumnName(i));  <span class="comment">//获取列名</span></div><div class="line">      jdbcTypes.add(JdbcType.forCode(metaData.getColumnType(i)));   <span class="comment">//获取列jdbc类型</span></div><div class="line">      classNames.add(metaData.getColumnClassName(i));   <span class="comment">//获取列Java类型</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面循环中三行代码处理结果集中的元数据在处理列jdbc类型和列Java类型中，会分别执行ResultSetMetaDataBase类中的getColumnType()和getColumnClassName()方法<br><em>ResultSetMetaDataBase.java</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getColumnType</span><span class="params">(<span class="keyword">int</span> column)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    <span class="keyword">return</span> getColumn(column).getColumnType();</div><div class="line">&#125;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getColumnClassName</span><span class="params">(<span class="keyword">int</span> column)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    <span class="keyword">return</span> getColumn(column).getColumnClassName();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>处理完成后程序开始返回返回到DefaultResultSetHandler.的handleResultSets()中继续执行下一步List<resultmap> resultMaps = mappedStatement.getResultMaps()获取mybatis中的结果集映射类型。执行while循环</resultmap></p>
<blockquote>
<p>handleResultSet(rsw, resultMap, multipleResults, null)=&gt;DefaultResultSetHandler.handleRowValues()=&gt;DefaultResultSetHandler.handleRowValuesForSimpleResultMap()=&gt;DefaultResultSetHandler.getRowValue()=&gt;DefaultResultSetHandler.applyAutomaticMappings()</p>
</blockquote>
<p>在applyAutomaticMappings方法中有两行代码分别处理类型和值<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">applyAutomaticMappings</span><span class="params">(ResultSetWrapper rsw, ResultMap resultMap, MetaObject metaObject, String columnPrefix)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">final</span> TypeHandler&lt;?&gt; typeHandler = rsw.getTypeHandler(propertyType, columnName);  <span class="comment">//获取类型</span></div><div class="line">    <span class="keyword">final</span> Object value = typeHandler.getResult(rsw.getResultSet(), columnName); <span class="comment">//获取值</span></div><div class="line">    ...</div><div class="line">    metaObject.setValue(property, value);   <span class="comment">//设置值</span></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在获取值得过程中，最终会调用ResultSet实例的getXXX方法获取具体值</p>
<p>在结果集映射完成后，返回到while循环执行下一步，直到结果集处理完成，层层返回处理的结果。一个查询过程完成。</p>
<h4 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h4><p>Mybatis执行查询的大体流程为:selectList()=&gt;execute()=&gt;handleResultSets()=&gt;返回结果</p>
<p>在handleResultSets()过程中主要分为三步：</p>
<ol>
<li>取数据，包装成结果集</li>
<li>处理元数据，进一步包装结果集</li>
<li>结果集映射返回Java类型，如Map<h3 id="elasticsearch和mybatis整合"><a href="#elasticsearch和mybatis整合" class="headerlink" title="elasticsearch和mybatis整合"></a>elasticsearch和mybatis整合</h3><h4 id="说明-1"><a href="#说明-1" class="headerlink" title="说明"></a>说明</h4>因为es并没有实际的JDBC驱动，elasticsearch-sql仅仅完成了从es取数据并包装成ResultSet的过程，即Mybatis第一步过程。<br>整合过程中需要完成Mybatis的第二布和第三步。同时完善资源的释放。补充JDBC规范中必须的setXXX完成?占位符参数替换(在Mybatis分页拦截插件测试中这个很重要)。</li>
</ol>
<p>在elasticsearch-sql的源码中，共7个类</p>
<blockquote>
<p><em>整合过程中新创建的类都必须放在com.alibaba.druid.pool包下</em></p>
<ol>
<li>ElasticSearchDruidDataSourceFactory.java—————数据源工厂类，用户创建数据源实例</li>
<li>ElasticSearchDruidDataSource.java———————-数据源</li>
<li>ElasticSearchConnection.java—————————物理connection连接</li>
<li>ElasticSearchDruidPooledConnection.java—————-连接池中的连接</li>
<li>ElasticSearchDruidPooledPreparedStatement.java———prepareStatement</li>
<li>ElasticSearchResultSet.java—————————-ResultSet结果集</li>
<li>ElasticSearchResultSetMetaDataBase.java—————-元数据<br><em>暂时没在GitHub上找到这个实验项目的源码，整合过程中需要修改源码的部分都是通过继承或拷贝部分代码的方式</em><h4 id="构造元数据信息"><a href="#构造元数据信息" class="headerlink" title="构造元数据信息"></a>构造元数据信息</h4>在es-sql的源码中，ElasticSearchResultSetMetaDataBase中使用了一个私有属性columns存储元数据，实际上在Mybatis是通过其父类ResultSetMetaDataBase中的私有属性columns获取元数据信息的。所以需要将构造的元数据填充到ResultSetMetaDataBase的columns中，重写ElasticSearchResultSetMetaDataBase.java</li>
</ol>
</blockquote>
<p><em>MybatisElasticSearchResultSetMetaDataBase.java</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisElasticSearchResultSetMetaDataBase</span> <span class="keyword">extends</span> <span class="title">ResultSetMetaDataBase</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MybatisElasticSearchResultSetMetaDataBase</span><span class="params">(List&lt;String&gt; headers)</span></span>&#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">        List&lt;ColumnMetaData&gt; columns = getColumns();</div><div class="line">        columns.clear();</div><div class="line">        <span class="keyword">for</span>(String column:headers)&#123;</div><div class="line">            ColumnMetaData columnMetaData = <span class="keyword">new</span> ColumnMetaData();</div><div class="line">            columnMetaData.setColumnLabel(column);</div><div class="line">            columnMetaData.setColumnName(column);</div><div class="line">            columns.add(columnMetaData);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getColumnType</span><span class="params">(<span class="keyword">int</span> column)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">return</span> Types.LONGVARCHAR;      <span class="comment">//JDBC类型为LONGVARCHAR</span></div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getColumnClassName</span><span class="params">(<span class="keyword">int</span> column)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"java.lang.String"</span>;      <span class="comment">//对应Java的String类型</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p><em>所有的数据类型都当做String处理</em></p>
</blockquote>
<p>复制一份ElasticSearchResultSet.java改为MybatisElasticSearchResultSet.java，修改构造方法中this.metaData = new ==MybatisElasticSearchResultSetMetaDataBase==(headers)，重写MybatisElasticSearchResultSet.java的close方法和部分getXXX方法</p>
<p><em>MybatisElasticSearchResultSet.java</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//测试的时候重不重写没发现有什么区别，MybatisElasticSearchResultSet就只是一个实现ResultSet接口的普通类，保险起见做下清空</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    iterator = <span class="keyword">null</span>;</div><div class="line">    current = <span class="keyword">null</span>;</div><div class="line">    headers = <span class="keyword">null</span>;</div><div class="line">    metaData = <span class="keyword">null</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**LONGVARCHAR被当做Clob处理*/</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Clob <span class="title">getClob</span><span class="params">(<span class="keyword">int</span> columnIndex)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    Object value = current.get(columnIndex);</div><div class="line">    <span class="keyword">if</span>(value == <span class="keyword">null</span>)&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MockClob(value.toString().getBytes());</div><div class="line">&#125;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Clob <span class="title">getClob</span><span class="params">(String columnLabel)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    Object value = current.get(headers.indexOf(columnLabel));</div><div class="line">    <span class="keyword">if</span>(value == <span class="keyword">null</span>)&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MockClob(value.toString().getBytes());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="重写物理连接的创建方法"><a href="#重写物理连接的创建方法" class="headerlink" title="重写物理连接的创建方法"></a>重写物理连接的创建方法</h4><p>实验项目的创建物理连接是把if判断注释了的，测试的时候发现连接不能正确释放，会报类型转换错误<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Connection <span class="title">createPhysicalConnection</span><span class="params">(String url, Properties info)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    Connection conn = <span class="keyword">new</span> MybatisElasticSearchConnection(url);</div><div class="line">    <span class="keyword">if</span> (getProxyFilters().size() &gt; <span class="number">0</span>) &#123;</div><div class="line">        conn = <span class="keyword">new</span> FilterChainImpl(<span class="keyword">this</span>).wrap(conn,info);</div><div class="line">    &#125;</div><div class="line">    createCount.incrementAndGet();</div><div class="line">    <span class="keyword">return</span> conn;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="重写DruidPooledPreparedStatement中execute和setXXX方法"><a href="#重写DruidPooledPreparedStatement中execute和setXXX方法" class="headerlink" title="重写DruidPooledPreparedStatement中execute和setXXX方法"></a>重写DruidPooledPreparedStatement中execute和setXXX方法</h4><p>Mybatis查询默认执行的是execute方法而不是executeQuery，所以需要继承ElasticSearchDruidPooledPreparedStatement添加该方法，修改executeQuery方法中 ResultSet rs = new ElasticSearchResultSet(this, headers, lines);为 ResultSet rs = new MybatisElasticSearchResultSet(this, headers, lines);</p>
<p>需要重写setXXX方法，在使用prepareStatement.setXXX(index,value)进行?参数替换时调用<br>修改client的创建方式</p>
<p><em>MybatisElasticSearchDruidPooledPreparedStatement.java</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisElasticSearchDruidPooledPreparedStatement</span> <span class="keyword">extends</span> <span class="title">DruidPooledPreparedStatement</span> </span>&#123;</div><div class="line">    LinkedList&lt;String&gt; sqlList = <span class="keyword">new</span> LinkedList&lt;String&gt;();<span class="comment">//存放分解的sql片段</span></div><div class="line">    Client client = <span class="keyword">null</span>;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MybatisElasticSearchDruidPooledPreparedStatement</span><span class="params">(DruidPooledConnection conn, PreparedStatementHolder holder)</span><span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">super</span>(conn,holder);</div><div class="line">        <span class="keyword">this</span>.client = ((ElasticSearchConnection)getOriginalConnection(conn.getConnection())).getClient();</div><div class="line">        sqlList.clear();</div><div class="line">        buildSqlList(getSql());</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> Connection <span class="title">getOriginalConnection</span><span class="params">(Connection conn)</span></span>&#123;</div><div class="line">        <span class="keyword">if</span>(conn <span class="keyword">instanceof</span> ConnectionProxyImpl)&#123;</div><div class="line">            <span class="keyword">return</span> ((ConnectionProxyImpl)conn).getConnectionRaw();</div><div class="line">        &#125;<span class="keyword">else</span>&#123;<span class="comment">//conn instanceof ElasticSearchConnection</span></div><div class="line">            <span class="keyword">return</span> conn;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//分解sql，如select * from tableName where a=? and b=?分解成 ["select * from tableName where a=","?"," and b=","?"]</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildSqlList</span><span class="params">(String sql)</span></span>&#123;</div><div class="line">        <span class="keyword">int</span> index = sql.indexOf(<span class="string">"?"</span>);</div><div class="line">        <span class="keyword">if</span>(index&lt;<span class="number">0</span>)&#123;</div><div class="line">            sqlList.add(sql);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        String preStr = sql.substring(<span class="number">0</span>,index);</div><div class="line">        sqlList.add(preStr);</div><div class="line">        sqlList.add(<span class="string">"?"</span>);</div><div class="line">        String afterStr = sql.substring(index+<span class="number">1</span>);</div><div class="line">        buildSqlList(afterStr);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//下面setXXX方法用于替换?参数</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setInt</span><span class="params">(<span class="keyword">int</span> parameterIndex, <span class="keyword">int</span> x)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        sqlList.set(<span class="number">2</span>*parameterIndex-<span class="number">1</span>,String.valueOf(x));</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setString</span><span class="params">(<span class="keyword">int</span> parameterIndex, String x)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        sqlList.set(<span class="number">2</span>*parameterIndex-<span class="number">1</span>,<span class="string">"'"</span>+x+<span class="string">"'"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDouble</span><span class="params">(<span class="keyword">int</span> parameterIndex, <span class="keyword">double</span> x)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        sqlList.set(<span class="number">2</span>*parameterIndex-<span class="number">1</span>,String.valueOf(x));</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDate</span><span class="params">(<span class="keyword">int</span> parameterIndex, java.sql.Date x)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</div><div class="line">        setString(parameterIndex,sdf.format(x));</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        sqlList.clear();<span class="comment">//做下清空操作</span></div><div class="line">        <span class="keyword">super</span>.close();</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ResultSet <span class="title">executeQuery</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        checkOpen();</div><div class="line">        incrementExecuteCount();</div><div class="line">        transactionRecord(getSql());</div><div class="line">        oracleSetRowPrefetch();</div><div class="line">        conn.beforeExecute();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ObjectResult extractor = getObjectResult(<span class="keyword">true</span>,StringUtils.join(sqlList.toArray(),<span class="string">""</span>), <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line">            List&lt;String&gt; headers = extractor.getHeaders();</div><div class="line">            List&lt;List&lt;Object&gt;&gt; lines = extractor.getLines();</div><div class="line">            ResultSet rs = <span class="keyword">new</span> MybatisElasticSearchResultSet(<span class="keyword">this</span>, headers, lines);</div><div class="line">            <span class="keyword">if</span> (rs == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">            DruidPooledResultSet poolableResultSet = <span class="keyword">new</span> DruidPooledResultSet(<span class="keyword">this</span>, rs);</div><div class="line">            addResultSetTrace(poolableResultSet);</div><div class="line">            <span class="keyword">return</span> poolableResultSet;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            <span class="keyword">throw</span> checkException(t);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            conn.afterExecute();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        checkOpen();</div><div class="line">        incrementExecuteCount();</div><div class="line">        transactionRecord(getSql());</div><div class="line">        oracleSetRowPrefetch();</div><div class="line">        conn.beforeExecute();</div><div class="line">        DruidPooledResultSet poolableResultSet = <span class="keyword">null</span>;</div><div class="line">        ResultSet rs = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ObjectResult extractor = getObjectResult(<span class="keyword">true</span>, StringUtils.join(sqlList.toArray(),<span class="string">""</span>), <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line">            List&lt;String&gt; headers = extractor.getHeaders();</div><div class="line">            List&lt;List&lt;Object&gt;&gt; lines = extractor.getLines();</div><div class="line">            rs = <span class="keyword">new</span> MybatisElasticSearchResultSet(<span class="keyword">this</span>, headers, lines);</div><div class="line">            poolableResultSet = <span class="keyword">new</span> DruidPooledResultSet(<span class="keyword">this</span>, rs);</div><div class="line">            addResultSetTrace(poolableResultSet);</div><div class="line">            </div><div class="line">            PreparedStatement stmt = <span class="keyword">this</span>.getPreparedStatementHolder().getStatement();</div><div class="line">            Method method = stmt.getClass().getDeclaredMethod(<span class="string">"setResultSet"</span>,ResultSet.class);</div><div class="line">            method.invoke(stmt,poolableResultSet);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            <span class="keyword">throw</span> checkException(t);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            conn.afterExecute();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//getObjectResult方法在父类中定义为private，不能继承，复制一份</span></div><div class="line">    <span class="function"><span class="keyword">private</span> ObjectResult <span class="title">getObjectResult</span><span class="params">(<span class="keyword">boolean</span> flat, String query, <span class="keyword">boolean</span> includeScore, <span class="keyword">boolean</span> includeType, <span class="keyword">boolean</span> includeId)</span> <span class="keyword">throws</span> SqlParseException, SQLFeatureNotSupportedException, Exception, CsvExtractorException </span>&#123;</div><div class="line">        SearchDao searchDao = <span class="keyword">new</span> org.nlpcn.es4sql.SearchDao(client);</div><div class="line">        QueryAction queryAction = searchDao.explain(query);</div><div class="line">        Object execution = QueryActionElasticExecutor.executeAnyAction(searchDao.getClient(), queryAction);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ObjectResultsExtractor(includeScore, includeType, includeId).extractResults(execution, flat);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h4 id="重写ElasticSearchConnection中prepareStatement创建，resultSet获取和资源释放等方法"><a href="#重写ElasticSearchConnection中prepareStatement创建，resultSet获取和资源释放等方法" class="headerlink" title="重写ElasticSearchConnection中prepareStatement创建，resultSet获取和资源释放等方法"></a>重写ElasticSearchConnection中prepareStatement创建，resultSet获取和资源释放等方法</h4><p>mybatis在获取结果集时会调用PrepareStatement实例中的getResultSet()方法和getUpdateCount()方法，在mybatis执行execute方法时，我们需要通过es client获取的数据包装成结果集放在PrepareStatement实例中暂存，在调用getResultSet()时返回暂存的实例</p>
<p><em>MybatisElasticSearchConnection.java</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisElasticSearchConnection</span> <span class="keyword">extends</span> <span class="title">ElasticSearchConnection</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Log LOG = LogFactory.getLog(MybatisElasticSearchConnection.class);</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MybatisElasticSearchConnection</span><span class="params">(String jdbcUrl)</span></span>&#123;</div><div class="line">        <span class="keyword">super</span>(jdbcUrl);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">this</span>.getClient().close();</div><div class="line">        LOG.info(<span class="string">"关闭连接"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> PreparedStatement <span class="title">prepareStatement</span><span class="params">(String sql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PreparedStatement() &#123;</div><div class="line">            <span class="keyword">private</span> ResultSet rs = <span class="keyword">null</span>;<span class="comment">//暂存通过es client获取的结果集</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResultSet</span><span class="params">(ResultSet rs)</span></span>&#123;<span class="comment">//自定义方法，不是JDBC规范中的方法，在prepareStatement的execute方法中通过反射调用</span></div><div class="line">                <span class="keyword">this</span>.rs = rs;</div><div class="line">            &#125;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> ResultSet <span class="title">getResultSet</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">                <span class="keyword">return</span> rs;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getUpdateCount</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">                <span class="keyword">return</span> -<span class="number">1</span>;  <span class="comment">//es-sql只支持查询，直接返回-1，否则resultset为null时mybatis会无限循环(mybatis当成update或insert操作，一直等待结果返回)</span></div><div class="line">            &#125;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">                <span class="keyword">if</span>(rs!=<span class="keyword">null</span>)&#123;</div><div class="line">                    rs.close();</div><div class="line">                    rs = <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//getClient().close();//应该在关闭连接时才关闭client</span></div><div class="line">            &#125;</div><div class="line">            ...</div><div class="line">            <span class="comment">//其它方法默认原es-sql代码实现</span></div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在es-sql中将关闭client的方法放在statement的close中，在使用连接池时，client的关闭应该随connection关闭而关闭，不应该是statement。</p>
<h4 id="修改ElasticSearchDruidPooledConnection-java"><a href="#修改ElasticSearchDruidPooledConnection-java" class="headerlink" title="修改ElasticSearchDruidPooledConnection.java"></a>修改ElasticSearchDruidPooledConnection.java</h4><p>创建MybatisElasticSearchDruidPooledConnection，继承自ElasticSearchDruidPooledConnection，创建一个私有方法getOriginalConnection(conn)，该方法是获取真实的连接。<br>拷贝父类两个prepareStatement方法，修改stmtHolder的创建方式，<br>将DruidPooledPreparedStatement rtnVal = new ==ElasticSearchDruidPooledPreparedStatement==(this, stmtHolder);改为<br>DruidPooledPreparedStatement rtnVal = new ==MybatisElasticSearchDruidPooledPreparedStatement==(this, stmtHolder);<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> PreparedStatement <span class="title">prepareStatement</span><span class="params">(String sql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    ...</div><div class="line">    stmtHolder = <span class="keyword">new</span> PreparedStatementHolder(key, getOriginalConnection(conn).prepareStatement(sql));</div><div class="line">    ...</div><div class="line">    DruidPooledPreparedStatement rtnVal = <span class="keyword">new</span> MybatisElasticSearchDruidPooledPreparedStatement(<span class="keyword">this</span>, stmtHolder);</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> PreparedStatement <span class="title">prepareStatement</span><span class="params">(String sql, <span class="keyword">int</span> resultSetType, <span class="keyword">int</span> resultSetConcurrency)</span></span>&#123;</div><div class="line">    ...</div><div class="line">    stmtHolder = <span class="keyword">new</span> PreparedStatementHolder(key, getOriginalConnection(conn).prepareStatement(sql, resultSetType,resultSetConcurrency));</div><div class="line">    ...</div><div class="line">    DruidPooledPreparedStatement rtnVal = <span class="keyword">new</span> MybatisElasticSearchDruidPooledPreparedStatement(<span class="keyword">this</span>, stmtHolder);</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> Connection <span class="title">getOriginalConnection</span><span class="params">(Connection conn)</span></span>&#123;</div><div class="line">    <span class="keyword">if</span>(conn <span class="keyword">instanceof</span> ConnectionProxyImpl)&#123;</div><div class="line">        <span class="keyword">return</span> ((ConnectionProxyImpl)conn).getConnectionRaw();</div><div class="line">    &#125;<span class="keyword">else</span>&#123;<span class="comment">//conn instanceof ElasticSearchConnection</span></div><div class="line">        <span class="keyword">return</span> conn;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="其它修改"><a href="#其它修改" class="headerlink" title="其它修改"></a>其它修改</h4><p>1.</p>
<blockquote>
<p>创建MybatisElasticSearchDruidDataSource，完全拷贝自ElasticSearchDruidDataSource，全局文本替换==ElasticSearch=&gt;MybatisElasticSearch==<br>2.<br>创建MybatisElasticSearchDruidDataSourceFactory，完全拷贝自ElasticSearchDruidDataSourceFactory，修改DataSource的创建方式DruidDataSource dataSource = new  ==MybatisElasticSearchDruidDataSource==();</p>
</blockquote>
<h4 id="创建datasrouce-es-xml并import到apppicationContext-xml"><a href="#创建datasrouce-es-xml并import到apppicationContext-xml" class="headerlink" title="创建datasrouce-es.xml并import到apppicationContext.xml"></a>创建datasrouce-es.xml并import到apppicationContext.xml</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">	<span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></div><div class="line">	<span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span> <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></div><div class="line">	<span class="attr">xmlns:jpa</span>=<span class="string">"http://www.springframework.org/schema/data/jpa"</span></div><div class="line">	<span class="attr">xmlns:security</span>=<span class="string">"http://www.springframework.org/schema/security"</span></div><div class="line">	<span class="attr">xmlns:util</span>=<span class="string">"http://www.springframework.org/schema/util"</span></div><div class="line">	<span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.0.xsd</span></div><div class="line">		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.0.xsd</div><div class="line">		http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-4.0.xsd</div><div class="line">		http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.0.xsd</div><div class="line">		http://www.springframework.org/schema/util</div><div class="line">		http://www.springframework.org/schema/util/spring-util.xsd"&gt;</div><div class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"defaulteDataSource-es"</span> <span class="attr">class</span>=<span class="string">"com.alibaba.druid.pool.MybatisElasticSearchDruidDataSource"</span> <span class="attr">init-method</span>=<span class="string">"init"</span> <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:elasticsearch://192.168.70.128:9300/"</span> /&gt;</span></div><div class="line">		<span class="comment">&lt;!-- 初始化连接大小 --&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"initialSize"</span> <span class="attr">value</span>=<span class="string">"2"</span> /&gt;</span></div><div class="line">		<span class="comment">&lt;!-- 连接池最小空闲 --&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minIdle"</span> <span class="attr">value</span>=<span class="string">"2"</span> /&gt;</span></div><div class="line">		<span class="comment">&lt;!-- 连接池最大使用连接数量 --&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxActive"</span> <span class="attr">value</span>=<span class="string">"100"</span> /&gt;</span></div><div class="line">		<span class="comment">&lt;!-- 获取连接最大等待时间 --&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxWait"</span> <span class="attr">value</span>=<span class="string">"60000"</span> /&gt;</span></div><div class="line">		<span class="comment">&lt;!-- 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒 --&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"timeBetweenEvictionRunsMillis"</span> <span class="attr">value</span>=<span class="string">"60000"</span> /&gt;</span></div><div class="line">		<span class="comment">&lt;!-- 配置一个连接在池中最小生存的时间，单位是毫秒 --&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minEvictableIdleTimeMillis"</span> <span class="attr">value</span>=<span class="string">"300000"</span> /&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"validationQuery"</span> <span class="attr">value</span>=<span class="string">"select 1 from dual"</span> /&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"testWhileIdle"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"testOnBorrow"</span> <span class="attr">value</span>=<span class="string">"false"</span> /&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"testOnReturn"</span> <span class="attr">value</span>=<span class="string">"false"</span> /&gt;</span></div><div class="line">		<span class="comment">&lt;!-- 打开PSCache，并且指定每个连接上PSCache的大小 --&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"poolPreparedStatements"</span> <span class="attr">value</span>=<span class="string">"false"</span> /&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxPoolPreparedStatementPerConnectionSize"</span> <span class="attr">value</span>=<span class="string">"20"</span> /&gt;</span></div><div class="line">		<span class="comment">&lt;!-- 打开removeAbandoned功能 --&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"removeAbandoned"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></div><div class="line">		<span class="comment">&lt;!-- 1800秒，也就是30分钟 --&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"removeAbandonedTimeout"</span> <span class="attr">value</span>=<span class="string">"1800"</span> /&gt;</span></div><div class="line">		<span class="comment">&lt;!-- 关闭abanded连接时输出错误日志 --&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"logAbandoned"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></div><div class="line"></div><div class="line">		<span class="comment">&lt;!-- 监控数据库 --&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"filters"</span> <span class="attr">value</span>=<span class="string">"stat,log4j"</span> /&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"connectionProperties"</span> <span class="attr">value</span>=<span class="string">"druid.stat.slowSqlMillis=5000"</span> /&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"defaultSQLSessionFactory-es"</span> <span class="attr">class</span>=<span class="string">"org.mybatis.spring.SqlSessionFactoryBean"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"defaulteDataSource-es"</span> /&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"configLocation"</span> <span class="attr">value</span>=<span class="string">"classpath:mybatis-config.xml"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mapperLocations"</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">array</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">value</span>&gt;</span>classpath*:bigdata/**/model/es/*.xml<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">array</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"defaultSQLSessionTemplate-es"</span> <span class="attr">class</span>=<span class="string">"org.mybatis.spring.SqlSessionTemplate"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">ref</span>=<span class="string">"defaultSQLSessionFactory-es"</span> /&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jdbcTemplate"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.core.JdbcTemplate"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span> = <span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"defaulteDataSource-es"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="关于分页查询"><a href="#关于分页查询" class="headerlink" title="关于分页查询"></a>关于分页查询</h3><p>es-sql支持分页查询，分页方式同mysql。在项目分页插件PaginationInterceptor中，如查询表radiott,获取数据总数的sql是<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="number">0</span>) <span class="keyword">as</span> COUNT_ALL <span class="keyword">from</span> (<span class="keyword">select</span> * <span class="keyword">from</span> radiott) tmp_count</div></pre></td></tr></table></figure></p>
<p>这种方式在es-sql中是不支持的，会报以下错误<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Caused by: java.lang.ClassCastException: com.alibaba.druid.sql.ast.statement.SQLSubqueryTableSource cannot be cast to com.alibaba.druid.sql.ast.statement.SQLJoinTableSource</div><div class="line">	at org.nlpcn.es4sql.parse.SqlParser.findFrom(SqlParser.java:227)</div><div class="line">	at org.nlpcn.es4sql.parse.SqlParser.parseSelect(SqlParser.java:48)</div><div class="line">	at org.nlpcn.es4sql.parse.SqlParser.parseSelect(SqlParser.java:35)</div><div class="line">	at org.nlpcn.es4sql.query.ESActionFactory.create(ESActionFactory.java:61)</div><div class="line">	at org.nlpcn.es4sql.SearchDao.explain(SearchDao.java:46)</div><div class="line">	at com.alibaba.druid.pool.MybatisElasticSearchDruidPooledPreparedStatement.getObjectResult(MybatisElasticSearchDruidPooledPreparedStatement.java:86)</div><div class="line">	at com.alibaba.druid.pool.MybatisElasticSearchDruidPooledPreparedStatement.execute(MybatisElasticSearchDruidPooledPreparedStatement.java:64)</div><div class="line">	... 32 more</div></pre></td></tr></table></figure></p>
<p>可以使用select count(*) as COUNT_ALL from radiott，可以count(字段名)，不能是count(0)，count(0)返回的是0。</p>
<h4 id="ElasticsearchServiceBase-java"><a href="#ElasticsearchServiceBase-java" class="headerlink" title="ElasticsearchServiceBase.java"></a>ElasticsearchServiceBase.java</h4><p>基本拷贝自ServiceBase.java,替换session为defaultSQLSessionTemplate-es，修改几处代码，在入参添加了一个属性datasource_type为elasticsearch，标识为es查询，用于在分页插件中区分。其中，分页时es允许的最大查询数量是10000。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> IMapEntry&lt;String, Object&gt; <span class="title">qryPage</span><span class="params">(String key, IMapEntry&lt;String, Object&gt; param)</span> </span>&#123;</div><div class="line">    param.put(<span class="string">"datasource_type"</span>,<span class="string">"elasticsearch"</span>);</div><div class="line">    IMapEntry&lt;String, Object&gt; result = qryPageInfo(key, param);</div><div class="line">    result.put(<span class="string">"data_list"</span>, qryPageList(key, param));</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"><span class="keyword">protected</span> List&lt;IMapEntry&lt;String, Object&gt;&gt; qryPageList(String key, IMapEntry&lt;String, Object&gt; param) &#123;</div><div class="line">        <span class="keyword">int</span> page_req = <span class="number">1</span>;</div><div class="line">        <span class="keyword">int</span> page_num = <span class="number">10000</span>; <span class="comment">//es允许的最大查询数量是10000</span></div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            page_req = param.getInteger(<span class="string">"page_req"</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            logger.debug(<span class="string">"分页参数-page_req 异常。"</span>);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (page_req &lt; <span class="number">1</span>) &#123;</div><div class="line">                page_req = <span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            page_num = param.getInteger(<span class="string">"page_num"</span>);</div><div class="line">            <span class="keyword">if</span>(page_num&gt;<span class="number">10000</span>)page_num=<span class="number">10000</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            logger.debug(<span class="string">"分页参数-page_num 异常。"</span>);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (page_num &lt; <span class="number">1</span>) &#123;</div><div class="line">                page_num = <span class="number">10000</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> session.selectList(key, param, <span class="keyword">new</span> RowBounds(page_req, page_num));</div><div class="line">    &#125;</div><div class="line"><span class="function"><span class="keyword">protected</span> IMapEntry&lt;String, Object&gt; <span class="title">qryPageInfo</span><span class="params">(String key, IMapEntry&lt;String, Object&gt; param)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">//计算行数时如2行，返回的是字符串2.0</span></div><div class="line">    rec_cnt = Double.valueOf(countMap.get(<span class="string">"count_all"</span>)).intValue();</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="ElasticsearchPaginationInterceptor-java"><a href="#ElasticsearchPaginationInterceptor-java" class="headerlink" title="ElasticsearchPaginationInterceptor.java"></a>ElasticsearchPaginationInterceptor.java</h4><p>基本拷贝自PaginationInterceptor，计算行数的sql为selct count(*) from xxx的方式。去掉oracle的相关判断。添加数据源的判断，不拦截非elasticsearch查询<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticsearchPaginationInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DO_QUERY_COUNT_FLG = <span class="string">"_DO_QUERY_COUNT_FLG_"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Log log = LogFactory.getLog(ElasticsearchPaginationInterceptor.class);</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ObjectFactory DEFAULT_OBJECT_FACTORY = <span class="keyword">new</span> DefaultObjectFactory();</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ObjectWrapperFactory DEFAULT_OBJECT_WRAPPER_FACTORY = <span class="keyword">new</span> DefaultObjectWrapperFactory();</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        StatementHandler statementHandler = (StatementHandler) invocation.getTarget();</div><div class="line">        MetaObject metaStatementHandler = MetaObject.forObject(statementHandler, DEFAULT_OBJECT_FACTORY, DEFAULT_OBJECT_WRAPPER_FACTORY);</div><div class="line"></div><div class="line">        DefaultParameterHandler defaultParameterHandler = (DefaultParameterHandler) metaStatementHandler.getValue(<span class="string">"delegate.parameterHandler"</span>);</div><div class="line">        Object parameterObj = defaultParameterHandler.getParameterObject();</div><div class="line">        <span class="keyword">if</span> (!(parameterObj <span class="keyword">instanceof</span> Map)) &#123;</div><div class="line">            log.debug(<span class="string">"查询时未使用Map类型的参数，直接查询不拦截"</span>);</div><div class="line">            <span class="keyword">return</span> invocation.proceed();</div><div class="line">        &#125;</div><div class="line">        Map parameterMap = (Map) defaultParameterHandler.getParameterObject();</div><div class="line">        Object datasource_type = parameterMap.get(<span class="string">"datasource_type"</span>);</div><div class="line">        <span class="keyword">if</span>(datasource_type==<span class="keyword">null</span>||StringUtils.isBlank(datasource_type.toString())||!<span class="string">"elasticsearch"</span>.equals(datasource_type.toString()))&#123;<span class="comment">//不是elasticsearch查询</span></div><div class="line">            log.debug(<span class="string">"非ElasticSearch查询，直接查询不拦截"</span>);</div><div class="line">            <span class="keyword">return</span> invocation.proceed();</div><div class="line">        &#125;</div><div class="line">        Object sidx = parameterMap.get(<span class="string">"_sidx"</span>);</div><div class="line">        Object sord = parameterMap.get(<span class="string">"_sord"</span>);</div><div class="line"></div><div class="line">        String originalSql = (String) metaStatementHandler.getValue(<span class="string">"delegate.boundSql.sql"</span>);</div><div class="line">        <span class="keyword">if</span> (sidx != <span class="keyword">null</span> &amp;&amp; sord != <span class="keyword">null</span>) &#123;</div><div class="line">            originalSql = originalSql + <span class="string">" order by "</span> + sidx + <span class="string">" "</span> + sord;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 取得SqlId</span></div><div class="line">        <span class="comment">// String originalSqlId = (String)</span></div><div class="line">        <span class="comment">// metaStatementHandler.getValue("delegate.mappedStatement.id");</span></div><div class="line">        <span class="comment">// 分页Count查询</span></div><div class="line">        Object countFlg = parameterMap.get(DO_QUERY_COUNT_FLG);</div><div class="line">        <span class="keyword">if</span> (countFlg != <span class="keyword">null</span> &amp;&amp; <span class="keyword">new</span> Boolean(ObjectUtils.toString(countFlg, <span class="string">"false"</span>))) &#123;</div><div class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">                log.debug(<span class="string">"分页查询，统计总数。"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">int</span> fromIndex = originalSql.toLowerCase().indexOf(<span class="string">"from"</span>);</div><div class="line">            String countSql = <span class="string">"select count(*) as COUNT_ALL "</span>+originalSql.substring(fromIndex);</div><div class="line">            metaStatementHandler.setValue(<span class="string">"delegate.boundSql.sql"</span>, countSql);</div><div class="line"></div><div class="line">            <span class="comment">//如果上一次有minRow，maxRow则移除</span></div><div class="line">            BoundSql boundSql = statementHandler.getBoundSql();</div><div class="line">            List&lt;ParameterMapping&gt; parameterMappings =<span class="keyword">new</span> ArrayList&lt;ParameterMapping&gt;();</div><div class="line">            parameterMappings.addAll(boundSql.getParameterMappings());</div><div class="line">            <span class="keyword">if</span> (parameterMappings != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterMappings.size(); i++) &#123;</div><div class="line">                    ParameterMapping parameterMapping = parameterMappings.get(i);</div><div class="line">                    <span class="keyword">if</span> (parameterMapping.getMode() != ParameterMode.OUT) &#123;</div><div class="line">                        Object value;</div><div class="line">                        String propertyName = parameterMapping.getProperty();</div><div class="line">                        <span class="keyword">if</span>(<span class="string">"maxRow"</span>.equals(propertyName)||<span class="string">"minRow"</span>.equals(propertyName))&#123;</div><div class="line">                            boundSql.getParameterMappings().remove(parameterMapping);</div><div class="line">                            log.debug(<span class="string">"remove:"</span>+propertyName);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> invocation.proceed();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        RowBounds rowBounds = (RowBounds) metaStatementHandler.getValue(<span class="string">"delegate.rowBounds"</span>);</div><div class="line">        <span class="keyword">if</span> (rowBounds == <span class="keyword">null</span> || rowBounds == RowBounds.DEFAULT) &#123;</div><div class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">                log.debug(<span class="string">"列表查询。"</span>);</div><div class="line">            &#125;</div><div class="line">            BoundSql boundSql = statementHandler.getBoundSql();</div><div class="line">            <span class="keyword">return</span> invocation.proceed();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">            log.debug(<span class="string">"分页查询，第"</span> + rowBounds.getOffset() + <span class="string">"页; 页数据量："</span> + rowBounds.getLimit() + <span class="string">"。"</span>);</div><div class="line">        &#125;</div><div class="line">        Configuration configuration = (Configuration) metaStatementHandler.getValue(<span class="string">"delegate.configuration"</span>);</div><div class="line">        String dialectType = configuration.getVariables().getProperty(<span class="string">"dialect"</span>);</div><div class="line">        <span class="keyword">if</span>(StringUtils.isBlank(dialectType))&#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"the value of the dialect property in mybatis-config.xml is not defined : "</span> + configuration.getVariables().getProperty(<span class="string">"dialect"</span>));</div><div class="line">        &#125;</div><div class="line">        Dialect.Type databaseType = Dialect.Type.valueOf(Dialect.Type.class, dialectType.toUpperCase());</div><div class="line">        Dialect dialect = <span class="keyword">new</span> MysqlDialect();;</div><div class="line">        <span class="keyword">int</span> minRow = rowBounds.getLimit() * (rowBounds.getOffset() - <span class="number">1</span>);</div><div class="line">        <span class="keyword">int</span> maxRow = rowBounds.getLimit();</div><div class="line">		<span class="comment">/* 计算查询行信息 */</span></div><div class="line">        metaStatementHandler.setValue(<span class="string">"delegate.boundSql.sql"</span>, dialect.getLimitString(originalSql, rowBounds.getOffset(), rowBounds.getLimit()));</div><div class="line">        <span class="comment">// 重置分页信息</span></div><div class="line">        metaStatementHandler.setValue(<span class="string">"delegate.rowBounds.offset"</span>, RowBounds.NO_ROW_OFFSET);</div><div class="line">        metaStatementHandler.setValue(<span class="string">"delegate.rowBounds.limit"</span>, RowBounds.NO_ROW_LIMIT);</div><div class="line">        <span class="comment">// 分页参数?化</span></div><div class="line">        BoundSql boundSql = statementHandler.getBoundSql();</div><div class="line">		<span class="comment">/* 添加分页参数 */</span></div><div class="line">        List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();</div><div class="line">        <span class="keyword">if</span> (parameterMappings == <span class="keyword">null</span> || (parameterMappings.size() == <span class="number">0</span> &amp;&amp; !(parameterMappings <span class="keyword">instanceof</span> ArrayList))) &#123;</div><div class="line">            parameterMappings = Lists.newArraylist();</div><div class="line">            Field parameterMappingsField = boundSql.getClass().getDeclaredField(<span class="string">"parameterMappings"</span>);</div><div class="line">            parameterMappingsField.setAccessible(<span class="keyword">true</span>);</div><div class="line">            parameterMappingsField.set(boundSql, parameterMappings);</div><div class="line">        &#125;</div><div class="line">        parameterMappings.add(<span class="keyword">new</span> ParameterMapping.Builder(configuration, <span class="string">"minRow"</span>, Integer.class).build());</div><div class="line">        parameterMappings.add(<span class="keyword">new</span> ParameterMapping.Builder(configuration, <span class="string">"maxRow"</span>, Integer.class).build());</div><div class="line">        parameterMap.put(<span class="string">"minRow"</span>, minRow);</div><div class="line">        parameterMap.put(<span class="string">"maxRow"</span>, maxRow);</div><div class="line">        <span class="keyword">return</span> invocation.proceed();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">plugin</span><span class="params">(Object target)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Plugin.wrap(target, <span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">paramMap2String</span><span class="params">(Map parameterMap)</span> </span>&#123;</div><div class="line">        StringBuilder sbReturn = <span class="keyword">new</span> StringBuilder();</div><div class="line">        <span class="keyword">if</span> (parameterMap != <span class="keyword">null</span> &amp;&amp; !parameterMap.isEmpty()) &#123;</div><div class="line">            sbReturn.append(<span class="string">"&lt;br/&gt;参数：&lt;br/&gt;"</span>);</div><div class="line"></div><div class="line">            Set&lt;Map.Entry&gt; en = parameterMap.entrySet();</div><div class="line">            <span class="keyword">for</span> (Map.Entry entry : en) &#123;</div><div class="line">                sbReturn.append(<span class="string">"&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;"</span>).append(entry.getKey()).append(<span class="string">" : ["</span>).append(entry.getValue()).append(<span class="string">"]&lt;br/&gt;"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> sbReturn.toString();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="sql支持"><a href="#sql支持" class="headerlink" title="sql支持"></a>sql支持</h3><p>支持列表：<a href="https://github.com/NLPchina/elasticsearch-sql" target="_blank" rel="external">https://github.com/NLPchina/elasticsearch-sql</a></p>
<ul>
<li>select a as a1 from xxx 和select a as “a1” from xxx的区别<br>两种查询方式的列名是不一样的，第一种是a1，取出方式：map.getString(“a1”),第二种是”a1”,取出方式：map.getString(“\\”a1\\””)。</li>
<li>不支持对多张join on的表进行count操作，会一直返回null<blockquote>
<p><em>es-sql对sql的支持度不如关系型数据库，编写sql时最好先用客户端工具测试</em></p>
<h3 id="maven依赖"><a href="#maven依赖" class="headerlink" title="maven依赖"></a>maven依赖</h3><p>整合过程中除了spring和mybatis外还依赖以下库</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.nlpcn<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-sql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>18.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
</blockquote>
</li>
</ul>
<h3 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h3><p>以上的改动是在GitHub上elasticsearch-sql的一个实验项目的基础上修改而来，感觉很多地方不合理，很多代码并不符合JDBC规范，创建连接的方式是直接修改数据源代码而不是写Driver。先这样做，先把功能需求实现了，后面有时间再研究下JDBC规范，考虑重写下。</p>

            
        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">标签</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/elasticsearch/">elasticsearch</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2017/07/16/elasticsearch-rest-api和mybatis整合记录/"  data-tooltip="elasticsearch rest api和mybatis整合记录">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2017/06/16/elasticsearh文档整理-查询/" data-tooltip="elasticsearh文档整理-查询">
                
                    <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://zhanyingf15.github.io/2017/07/15/elasticserch-sql和mybatis整合记录/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://zhanyingf15.github.io/2017/07/15/elasticserch-sql和mybatis整合记录/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://zhanyingf15.github.io/2017/07/15/elasticserch-sql和mybatis整合记录/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#ds-thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#table-of-contents">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


        
            
                <!--
<div id="ds-thread" class="ds-thread" data-thread-key="2017/07/15/elasticserch-sql和mybatis整合记录/"
     data-title="elasticserch-sql和mybatis整合记录" data-url="https://zhanyingf15.github.io/2017/07/15/elasticserch-sql和mybatis整合记录/">
</div>
-->
<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="2017/07/15/elasticserch-sql和mybatis整合记录/" data-title="elasticserch-sql和mybatis整合记录" data-url="https://zhanyingf15.github.io/2017/07/15/elasticserch-sql和mybatis整合记录/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"wangyu1992"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2017 忘语. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="3">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2017/07/16/elasticsearch-rest-api和mybatis整合记录/"  data-tooltip="elasticsearch rest api和mybatis整合记录">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2017/06/16/elasticsearh文档整理-查询/" data-tooltip="elasticsearh文档整理-查询">
                
                    <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://zhanyingf15.github.io/2017/07/15/elasticserch-sql和mybatis整合记录/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://zhanyingf15.github.io/2017/07/15/elasticserch-sql和mybatis整合记录/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://zhanyingf15.github.io/2017/07/15/elasticserch-sql和mybatis整合记录/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#ds-thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#table-of-contents">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="3">
    <ul class="share-options">
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=https://zhanyingf15.github.io/2017/07/15/elasticserch-sql和mybatis整合记录/">
                <i class="fa fa-google-plus"></i><span class="">分享到 Google+</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://zhanyingf15.github.io/2017/07/15/elasticserch-sql和mybatis整合记录/">
                <i class="fa fa-facebook-official"></i><span>分享到 Facebook</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https://zhanyingf15.github.io/2017/07/15/elasticserch-sql和mybatis整合记录/">
                <i class="fa fa-twitter"></i><span>分享到 Twitter</span>
            </a>
        </li>
    </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/me.jpg"/>
        
            <h4 id="about-card-name">忘语</h4>
        
            <h5 id="about-card-bio"><h3 id="热爱生活-享受code"><a href="#热爱生活-享受code" class="headerlink" title="热爱生活,享受code"></a>热爱生活,享受code</h3></h5>
        
        
            <h5 id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <h4 id="一名虔诚的程序猿"><a href="#一名虔诚的程序猿" class="headerlink" title="一名虔诚的程序猿"></a>一名虔诚的程序猿</h4>
            </h5>
        
        
    </div>
</div>

        
<div id="cover" style="background-image:url('http://ww1.sinaimg.cn/large/86135ceagy1fc0pkcjc5oj21hc0u0gun.jpg');"></div>
    </body>
    <!--SCRIPTS-->
<script src="/assets/js/script-i4qo6jx6jji9fg0dftpya6ivemizsbow4fhow76d8dwpm7m1wbvi378ssumx.min.js"></script>
<!--SCRIPTS END-->

    
        <script type="text/javascript">
            var duoshuoQuery = {short_name:'wangyu1992'};
            (function() {
                var ds = document.createElement('script');
                ds.type = 'text/javascript';ds.async = true;
                ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
                ds.charset = 'UTF-8';
                (document.getElementsByTagName('head')[0]
                || document.getElementsByTagName('body')[0]).appendChild(ds);
            })();
        </script>
    



</html>
