
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="忘语的个人博客">
    <title>分类: elasticsearch - 忘语的个人博客</title>
    <meta name="author" content="忘语">
    
    
        <link rel="icon" href="https://zhanyingf15.github.io/assets/images/favicon.png">
    
    
    <meta name="description" content="阳光下做人，风雨中做事">
<meta property="og:type" content="blog">
<meta property="og:title" content="忘语的个人博客">
<meta property="og:url" content="https://zhanyingf15.github.io/categories/大数据/elasticsearch/index.html">
<meta property="og:site_name" content="忘语的个人博客">
<meta property="og:description" content="阳光下做人，风雨中做事">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="忘语的个人博客">
<meta name="twitter:description" content="阳光下做人，风雨中做事">
    
    
        
    
    
        <meta property="og:image" content="https://zhanyingf15.github.io/assets/images/me.jpg"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-nuvue6sithwirecbhvw3dkaobiojqvtadsnhguwi7k04xklybw5djl1smadp.min.css">
    <!--STYLES END-->
    
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/ ">忘语的个人博客</a>
    </h1>
    
        
            <a  class="header-right-picture "
                href="#about">
        
        
            <img class="header-picture" src="/assets/images/me.jpg"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="1">
    
        <div class="sidebar-profile">
            <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/me.jpg"/>
            </a>
            <span class="sidebar-profile-name">忘语</span>
        </div>
    
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/ "
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">首页</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-categories"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                    <span class="sidebar-button-desc">分类</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-tags"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">标签</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-archives"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
                    <span class="sidebar-button-desc">归档</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="#about"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-question"></i>
                    <span class="sidebar-button-desc">关于</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://github.com/zhanyingf15" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-github"></i>
                    <span class="sidebar-button-desc">GitHub</span>
                </a>
        </li>
        
    </ul>
    
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
    

<section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-right" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2017/06/16/elasticsearh文档整理-查询/">
                            elasticsearh文档整理-查询
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2017-06-16T18:03:11+08:00">
	
		    6月 16, 2017
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/大数据/">大数据</a>, <a class="category-link" href="/categories/大数据/elasticsearch/">elasticsearch</a>


    
</div>

            </div>
            
                <div class="postShorten-excerpt" itemprop="articleBody">
                    <p>翻译自elasticsearch官方文档，整理了java api和rest api的文档部分，仅仅是整理翻译，不是逐字逐句，某些遗漏部分请移步官方文档。</p>
<p>[TOC]</p>
<blockquote>
<p>elasticsearch版本：2.4.5</p>
<h3 id="Docment-API"><a href="#Docment-API" class="headerlink" title="Docment API"></a>Docment API</h3><p>基础的CRUD API<br><a href="https://www.elastic.co/guide/en/elasticsearch/client/java-api/2.4/java-docs.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/client/java-api/2.4/java-docs.html</a></p>
</blockquote>
                    
                        <a href="/2017/06/16/elasticsearh文档整理-查询/" class="postShorten-excerpt_link link">
                            阅读全文
                        </a>
                        
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2017/06/16/elasticsearh文档整理-聚合/">
                            elasticsearh文档整理-聚合
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2017-06-16T17:53:19+08:00">
	
		    6月 16, 2017
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/大数据/">大数据</a>, <a class="category-link" href="/categories/大数据/elasticsearch/">elasticsearch</a>


    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <p>翻译自elasticsearch官方文档，整理了java api和rest api的文档部分，仅仅是整理翻译，不是逐字逐句，某些遗漏部分请移步官方文档。</p>
<p>[TOC]</p>
<h2 id="聚合"><a href="#聚合" class="headerlink" title="聚合"></a>聚合</h2><p>基础使用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">SearchResponse sr = client.prepareSearch()</div><div class="line">    .setQuery(QueryBuilders.matchAllQuery())</div><div class="line">    .addAggregation(</div><div class="line">            AggregationBuilders.terms(<span class="string">"agg1"</span>).field(<span class="string">"field"</span>)</div><div class="line">    )</div><div class="line">    .addAggregation(</div><div class="line">            AggregationBuilders.dateHistogram(<span class="string">"agg2"</span>)</div><div class="line">                    .field(<span class="string">"birth"</span>)</div><div class="line">                    .interval(DateHistogramInterval.YEAR)</div><div class="line">    )</div><div class="line">    .execute().actionGet();</div><div class="line">Terms agg1 = sr.getAggregations().get(<span class="string">"agg1"</span>);</div><div class="line">DateHistogram agg2 = sr.getAggregations().get(<span class="string">"agg2"</span>);</div></pre></td></tr></table></figure></p>
<p>&lt;— excerpt –&gt;</p>
<h3 id="结构化聚合"><a href="#结构化聚合" class="headerlink" title="结构化聚合"></a>结构化聚合</h3><p>一个聚合中能够包含子聚合，聚合只能是metrics聚合或bucket聚合。例如，下面的聚合由三个子聚合组成</p>
<ul>
<li>Terms 聚合 (bucket)</li>
<li>Date Histogram 聚合 (bucket)</li>
<li>Average 聚合 (metric)<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">SearchResponse sr = node.client().prepareSearch()</div><div class="line">    .addAggregation(</div><div class="line">        AggregationBuilders.terms(<span class="string">"by_country"</span>).field(<span class="string">"country"</span>)</div><div class="line">        .subAggregation(AggregationBuilders.dateHistogram(<span class="string">"by_year"</span>)</div><div class="line">            .field(<span class="string">"dateOfBirth"</span>)</div><div class="line">            .interval((DateHistogramInterval.YEAR)</div><div class="line">            .subAggregation(AggregationBuilders.avg(<span class="string">"avg_children"</span>).field(<span class="string">"children"</span>))</div><div class="line">        )</div><div class="line">    )</div><div class="line">    .execute().actionGet();</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Metrics类型聚合"><a href="#Metrics类型聚合" class="headerlink" title="Metrics类型聚合"></a>Metrics类型聚合</h3><h4 id="min"><a href="#min" class="headerlink" title="min"></a>min</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">MetricsAggregationBuilder aggregation = AggregationBuilders.min(<span class="string">"agg"</span>).field(<span class="string">"height"</span>);</div><div class="line">Min agg = sr.getAggregations().get(<span class="string">"agg"</span>);</div><div class="line"><span class="keyword">double</span> value = agg.getValue();</div></pre></td></tr></table></figure>
<h4 id="max"><a href="#max" class="headerlink" title="max"></a>max</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">MetricsAggregationBuilder aggregation = AggregationBuilders.max(<span class="string">"agg"</span>).field(<span class="string">"height"</span>);</div><div class="line">Max agg = sr.getAggregations().get(<span class="string">"agg"</span>);</div><div class="line"><span class="keyword">double</span> value = agg.getValue();</div></pre></td></tr></table></figure>
<h4 id="sum"><a href="#sum" class="headerlink" title="sum"></a>sum</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">MetricsAggregationBuilder aggregation = AggregationBuilders.sum(<span class="string">"agg"</span>).field(<span class="string">"height"</span>);</div><div class="line">Sum agg = sr.getAggregations().get(<span class="string">"agg"</span>);</div><div class="line"><span class="keyword">double</span> value = agg.getValue();</div></pre></td></tr></table></figure>
<h4 id="avg"><a href="#avg" class="headerlink" title="avg"></a>avg</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">MetricsAggregationBuilder aggregation = AggregationBuilders.avg(<span class="string">"agg"</span>).field(<span class="string">"height"</span>);</div><div class="line">Avg agg = sr.getAggregations().get(<span class="string">"agg"</span>);</div><div class="line"><span class="keyword">double</span> value = agg.getValue();</div></pre></td></tr></table></figure>
<h4 id="count"><a href="#count" class="headerlink" title="count"></a>count</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">MetricsAggregationBuilder aggregation = AggregationBuilders.count(<span class="string">"agg"</span>).field(<span class="string">"height"</span>);</div><div class="line">ValueCount agg = sr.getAggregations().get(<span class="string">"agg"</span>);</div><div class="line"><span class="keyword">long</span> value = agg.getValue();</div></pre></td></tr></table></figure>
<h4 id="stats聚合"><a href="#stats聚合" class="headerlink" title="stats聚合"></a>stats聚合</h4><p>直接stats聚合替代sum,avg等聚合<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">MetricsAggregationBuilder aggregation = AggregationBuilders.stats(<span class="string">"agg"</span>).field(<span class="string">"height"</span>);</div><div class="line">Stats agg = sr.getAggregations().get(<span class="string">"agg"</span>);</div><div class="line"><span class="keyword">double</span> min = agg.getMin();</div><div class="line"><span class="keyword">double</span> max = agg.getMax();</div><div class="line"><span class="keyword">double</span> avg = agg.getAvg();</div><div class="line"><span class="keyword">double</span> sum = agg.getSum();</div><div class="line"><span class="keyword">long</span> count = agg.getCount();</div></pre></td></tr></table></figure></p>
<h4 id="Extended-Stats聚合"><a href="#Extended-Stats聚合" class="headerlink" title="Extended Stats聚合"></a>Extended Stats聚合</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">MetricsAggregationBuilder aggregation = AggregationBuilders.extendedStats(<span class="string">"agg"</span>).field(<span class="string">"height"</span>);</div><div class="line">ExtendedStats agg = sr.getAggregations().get(<span class="string">"agg"</span>);</div><div class="line"><span class="keyword">double</span> min = agg.getMin();</div><div class="line"><span class="keyword">double</span> max = agg.getMax();</div><div class="line"><span class="keyword">double</span> avg = agg.getAvg();</div><div class="line"><span class="keyword">double</span> sum = agg.getSum();</div><div class="line"><span class="keyword">long</span> count = agg.getCount();</div><div class="line"><span class="keyword">double</span> stdDeviation = agg.getStdDeviation();    <span class="comment">//误差</span></div><div class="line"><span class="keyword">double</span> sumOfSquares = agg.getSumOfSquares();    </div><div class="line"><span class="keyword">double</span> variance = agg.getVariance();    <span class="comment">//方差</span></div></pre></td></tr></table></figure>
<h4 id="Percentiles聚合-百分比统计"><a href="#Percentiles聚合-百分比统计" class="headerlink" title="Percentiles聚合,百分比统计"></a>Percentiles聚合,百分比统计</h4><p>多值metrics聚合，从被聚合的文档中提取数值计算一个或者多个百分比，这些数值可以是指定的字段，也可以由提供的脚本生成。<a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.4/search-aggregations-metrics-percentile-aggregation.html" target="_blank" rel="external">详情参考官方说明</a>。</p>
<p>Percentiles表示被观察数值发生的具体概率。Percentiles通常用来寻找异常值。假设你的数据中包含网站的加载时间，网站加载时间的平均值和中值对于管理人员来说非常有用，最大值通常更令人关注，但是它非常容易被一个缓慢响应歪斜。</p>
<p>下面一个示例中,请求体是：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"aggs"</span> : &#123;</div><div class="line">        <span class="attr">"load_time_outlier"</span> : &#123;</div><div class="line">            <span class="attr">"percentiles"</span> : &#123;</div><div class="line">                <span class="attr">"field"</span> : <span class="string">"load_time"</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果可能是：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    ...</div><div class="line">   "aggregations": &#123;</div><div class="line">      "load_time_outlier": &#123;</div><div class="line">         "values" : &#123;</div><div class="line">            "1.0": 15,</div><div class="line">            "5.0": 20,</div><div class="line">            "25.0": 23,</div><div class="line">            "50.0": 25,</div><div class="line">            "75.0": 29,</div><div class="line">            "95.0": 60,</div><div class="line">            "99.0": 150</div><div class="line">         &#125;</div><div class="line">      &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>聚合过程将会为每一个默认指定范围的百分比值返回一个计算后的值，假设返回的数值都是毫秒，从返回结果中就能明显看出网站的正常加载时间是15-30ms（约75%），少量加载时间是60-150ms（约4%）。</p>
<p>通常情况下，管理人员对更极端的数值更感兴趣，我们可以指定需要的百分比进行统计计算。<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"aggs"</span> : &#123;</div><div class="line">        <span class="attr">"load_time_outlier"</span> : &#123;</div><div class="line">            <span class="attr">"percentiles"</span> : &#123;</div><div class="line">                <span class="attr">"field"</span> : <span class="string">"load_time"</span>,</div><div class="line">                <span class="attr">"percents"</span> : [<span class="number">95</span>, <span class="number">99</span>, <span class="number">99.9</span>] </div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Java使用示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//使用默认指定的百分率范围</span></div><div class="line">MetricsAggregationBuilder aggregation = AggregationBuilders.percentiles(<span class="string">"agg"</span>).field(<span class="string">"height"</span>); </div><div class="line"></div><div class="line"><span class="comment">//使用自定义百分率范围</span></div><div class="line">MetricsAggregationBuilder aggregation = AggregationBuilders.percentiles(<span class="string">"agg"</span>).field(<span class="string">"height"</span>)</div><div class="line">    .percentiles(<span class="number">1.0</span>, <span class="number">5.0</span>, <span class="number">10.0</span>, <span class="number">20.0</span>, <span class="number">30.0</span>, <span class="number">75.0</span>, <span class="number">95.0</span>, <span class="number">99.0</span>);</div><div class="line">    </div><div class="line"><span class="comment">// searchResponse是查询请求返回的实例</span></div><div class="line">Percentiles agg = searchResponse.getAggregations().get(<span class="string">"agg"</span>);</div><div class="line"><span class="comment">//遍历</span></div><div class="line"><span class="keyword">for</span> (Percentile entry : agg) &#123;</div><div class="line">    <span class="keyword">double</span> percent = entry.getPercent();    <span class="comment">// Percent</span></div><div class="line">    <span class="keyword">double</span> value = entry.getValue();        <span class="comment">// Value</span></div><div class="line">    logger.info(<span class="string">"percent [&#123;&#125;], value [&#123;&#125;]"</span>, percent, value);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后打印可能是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">percent [1.0], value [0.814338896154595]</div><div class="line">percent [5.0], value [0.8761912455821302]</div><div class="line">percent [25.0], value [1.173346540141847]</div><div class="line">percent [50.0], value [1.5432023318692198]</div><div class="line">percent [75.0], value [1.923915462033674]</div><div class="line">percent [95.0], value [2.2273644908535335]</div><div class="line">percent [99.0], value [2.284989339108279]</div></pre></td></tr></table></figure></p>
<h4 id="Percentile-rank聚合"><a href="#Percentile-rank聚合" class="headerlink" title="Percentile rank聚合"></a>Percentile rank聚合</h4><p>Percentile rank表示被观察数据中小于指定数值的百分概率。假设你的数据中包含网站的加载时间，你可能有一个服务协议要求95%的页面加载时间在15ms以内，99%的页面加载时间在30ms以内。</p>
<p>请求数据如下：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"aggs"</span> : &#123;</div><div class="line">        <span class="attr">"load_time_outlier"</span> : &#123;</div><div class="line">            <span class="attr">"percentile_ranks"</span> : &#123;</div><div class="line">                <span class="attr">"field"</span> : <span class="string">"load_time"</span>, </div><div class="line">                <span class="attr">"values"</span> : [<span class="number">15</span>, <span class="number">30</span>]</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果如下：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    ...</div><div class="line">   "aggregations": &#123;</div><div class="line">      "load_time_outlier": &#123;</div><div class="line">         "values" : &#123;</div><div class="line">            "15": 92,</div><div class="line">            "30": 100</div><div class="line">         &#125;</div><div class="line">      &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从上面的结果可以看出只有92%的页面加载时间在15ms以内，但是所有的页面加载时间都在30ms以内。</p>
<p>Java使用示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">MetricsAggregationBuilder aggregation = AggregationBuilders</div><div class="line">                .percentileRanks(<span class="string">"agg"</span>)</div><div class="line">                .field(<span class="string">"height"</span>)</div><div class="line">                .percentiles(<span class="number">1.24</span>, <span class="number">1.91</span>, <span class="number">2.22</span>);</div><div class="line"><span class="comment">// searchResponse是查询请求返回的实例</span></div><div class="line">PercentileRanks agg = sr.getAggregations().get(<span class="string">"agg"</span>);</div><div class="line"><span class="comment">// For each entry</span></div><div class="line"><span class="keyword">for</span> (Percentile entry : agg) &#123;</div><div class="line">    <span class="keyword">double</span> percent = entry.getPercent();    <span class="comment">// Percent</span></div><div class="line">    <span class="keyword">double</span> value = entry.getValue();        <span class="comment">// Value</span></div><div class="line"></div><div class="line">    logger.info(<span class="string">"percent [&#123;&#125;], value [&#123;&#125;]"</span>, percent, value);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">percent [29.664353095090945], value [1.24]</div><div class="line">percent [73.9335313461868], value [1.91]</div><div class="line">percent [94.40095147327283], value [2.22]</div></pre></td></tr></table></figure></p>
<h4 id="Cardinality聚合"><a href="#Cardinality聚合" class="headerlink" title="Cardinality聚合"></a>Cardinality聚合</h4><p>对某个字段不同值计算近似的数量，类似于sql中select count( <em> ) from (select distinct </em> from table)，如计算所有书中不同作者的数量<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"aggs"</span> : &#123;</div><div class="line">        <span class="attr">"author_count"</span> : &#123;</div><div class="line">            <span class="attr">"cardinality"</span> : &#123;</div><div class="line">                <span class="attr">"field"</span> : <span class="string">"author"</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>注意：Cardinality聚合统计的是分词后的不同值的数量。在测试中，测试数据name字段有三列值，分别是[“张三”,”李四”,”张三”],按照传统关系型数据库的理解，结果应该返回 2，使用Cardinality聚合结果返回 4，因为在插入测试数据的时候name字段的值被分词了，被分解成[[“张”,”三”],[“李”,”四”],[“张”,”三”]]，最终计算不同值的数量是4。</p>
</blockquote>
<p>官方文档着重强调了Cardinality聚合计算的是近似值，具体详见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.4/search-aggregations-metrics-cardinality-aggregation.html#_counts_are_approximate" target="_blank" rel="external">官方文档</a></p>
<h4 id="Geo-Bounds聚合"><a href="#Geo-Bounds聚合" class="headerlink" title="Geo Bounds聚合"></a>Geo Bounds聚合</h4><p>根据指定字段的geo_point值计算边界<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">GeoBoundsBuilder aggregation = AggregationBuilders.geoBounds(<span class="string">"agg"</span>).field(<span class="string">"address.location"</span>).wrapLongitude(<span class="keyword">true</span>);</div><div class="line"></div><div class="line"><span class="comment">// searchResponse是查询请求返回的实例</span></div><div class="line">GeoBounds agg = searchResponse.getAggregations().get(<span class="string">"agg"</span>);</div><div class="line">GeoPoint bottomRight = agg.bottomRight();</div><div class="line">GeoPoint topLeft = agg.topLeft();</div><div class="line">logger.info(<span class="string">"bottomRight &#123;&#125;, topLeft &#123;&#125;"</span>, bottomRight, topLeft);</div></pre></td></tr></table></figure></p>
<p>打印结果是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bottomRight [40.70500764381921, 13.952946866893775], topLeft [53.49603022435221, -4.190029308156676]</div></pre></td></tr></table></figure></p>
<p>wrapLongitude(true)是指边界是否允许和国际日期变更线重合，默认值是true。</p>
<h4 id="Top-hits聚合"><a href="#Top-hits聚合" class="headerlink" title="Top hits聚合"></a>Top hits聚合</h4><p>top hits聚合能够追踪被聚合后的文档，通常用来作为其它聚合器的子聚合，它能从每个桶中聚合出最先匹配的文档。<br>可选的选项如下：</p>
<ol>
<li>from:偏移量，从的第一个聚合结果获取新的结果的偏移量。</li>
<li>size:从每个桶中获取的最大数量，默认值 3。</li>
<li>sort:排序方式，默认同主查询的排序方式一致。</li>
</ol>
<p>top hits聚合就是作为一个聚合器的子聚合，在父聚合完成形成桶后，在桶中挑选排在前面的几个文档。size是指在每个桶中挑选的数量，并不是最终返回的数量。<a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.4/search-aggregations-metrics-top-hits-aggregation.html" target="_blank" rel="external">官方文档</a></p>
<p>Java使用示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">AggregationBuilder aggregation = AggregationBuilders</div><div class="line">        .terms(<span class="string">"agg"</span>).field(<span class="string">"gender"</span>)   <span class="comment">//先按照性别聚合</span></div><div class="line">        .subAggregation(</div><div class="line">            AggregationBuilders.topHits(<span class="string">"top"</span>)</div><div class="line">                .setExplain(<span class="keyword">true</span>)</div><div class="line">                .setSize(<span class="number">1</span>)     <span class="comment">//从每个桶中取1条数据</span></div><div class="line">                .setFrom(<span class="number">10</span>)    <span class="comment">//偏移量为10</span></div><div class="line">        );</div><div class="line">...</div><div class="line"></div><div class="line"><span class="comment">// searchResponse是查询请求返回的实例</span></div><div class="line">Terms agg = searchResponse.getAggregations().get(<span class="string">"agg"</span>);</div><div class="line"></div><div class="line"><span class="keyword">for</span> (Terms.Bucket entry : agg.getBuckets()) &#123;</div><div class="line">    String key = entry.getKey();                    <span class="comment">// bucket key</span></div><div class="line">    <span class="keyword">long</span> docCount = entry.getDocCount();            <span class="comment">// Doc count</span></div><div class="line">    logger.info(<span class="string">"key [&#123;&#125;], doc_count [&#123;&#125;]"</span>, key, docCount);</div><div class="line"></div><div class="line">    <span class="comment">// We ask for top_hits for each bucket</span></div><div class="line">    TopHits topHits = entry.getAggregations().get(<span class="string">"top"</span>);</div><div class="line">    <span class="keyword">for</span> (SearchHit hit : topHits.getHits().getHits()) &#123;</div><div class="line">        logger.info(<span class="string">" -&gt; id [&#123;&#125;], _source [&#123;&#125;]"</span>, hit.getId(), hit.getSourceAsString());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印的数据是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">key [male], doc_count [5107]</div><div class="line"> -&gt; id [AUnzSZze9k7PKXtq04x2], _source [&#123;&quot;gender&quot;:&quot;male&quot;,...&#125;]</div><div class="line"> -&gt; id [AUnzSZzj9k7PKXtq04x4], _source [&#123;&quot;gender&quot;:&quot;male&quot;,...&#125;]</div><div class="line"> -&gt; id [AUnzSZzl9k7PKXtq04x5], _source [&#123;&quot;gender&quot;:&quot;male&quot;,...&#125;]</div><div class="line">key [female], doc_count [4893]</div><div class="line"> -&gt; id [AUnzSZzM9k7PKXtq04xy], _source [&#123;&quot;gender&quot;:&quot;female&quot;,...&#125;]</div><div class="line"> -&gt; id [AUnzSZzp9k7PKXtq04x8], _source [&#123;&quot;gender&quot;:&quot;female&quot;,...&#125;]</div><div class="line"> -&gt; id [AUnzSZ0W9k7PKXtq04yS], _source [&#123;&quot;gender&quot;:&quot;female&quot;,...&#125;]</div></pre></td></tr></table></figure></p>
<h4 id="Scripted-Metric聚合"><a href="#Scripted-Metric聚合" class="headerlink" title="Scripted Metric聚合"></a>Scripted Metric聚合</h4><p>实验特性，后续版本可能会被移除，具体参考<a href="https://www.elastic.co/guide/en/elasticsearch/client/java-api/2.4/_metrics_aggregations.html#java-aggs-metrics-scripted-metric" target="_blank" rel="external">官方文档</a></p>
<h3 id="Bucket类型聚合"><a href="#Bucket类型聚合" class="headerlink" title="Bucket类型聚合"></a>Bucket类型聚合</h3><h4 id="Global聚合"><a href="#Global聚合" class="headerlink" title="Global聚合"></a>Global聚合</h4><p>在一个查询执行环境中为所有的文档定义一个全局的桶，这个执行环境就是你所查询的索引和类型定义的环境，它不受查询本身影响。</p>
<blockquote>
<p>注意：Global聚合只能作为放在顶层的聚合器，嵌入的Global聚合器不能感知到嵌入的其它bucket聚合器。ps:顶层聚合器，原文是top level aggregators，意思是一个聚合器有多个子聚合器，Global聚合器必须放在第一位(代码顺序)</p>
</blockquote>
<p>具体示例如下：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    "query" : &#123;</div><div class="line">        "match" : &#123; "title" : "shirt" &#125;</div><div class="line">    &#125;,</div><div class="line">    "aggs" : &#123;</div><div class="line">        "all_products" : &#123;</div><div class="line">            "global" : &#123;&#125;,  //global聚合器是一个空结构体(必须放在第一位)</div><div class="line">            "aggs" : &#123;      //子聚合器</div><div class="line">                "avg_price" : &#123; "avg" : &#123; "field" : "price" &#125; &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果如下：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    "aggregations" : &#123;</div><div class="line">        "all_products" : &#123;</div><div class="line">            "doc_count" : 100, </div><div class="line">            "avg_price" : &#123;</div><div class="line">                "value" : 56.3</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的聚合示例了怎样在查询环境中对所有文档进行聚合计算(对所有商品价格求平均值)，同时忽略查询条件。在这示例中，查询条件是查出所有的衬衫，同时完成对所有的商品价格计算平均值。</p>
<p>Java示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">AggregationBuilders.global(<span class="string">"agg"</span>).subAggregation(AggregationBuilders.terms(<span class="string">"genders"</span>).field(<span class="string">"gender"</span>));</div><div class="line">...</div><div class="line">Global agg = searchResponse.getAggregations().get(<span class="string">"agg"</span>);</div><div class="line">agg.getDocCount(); <span class="comment">// Doc count</span></div></pre></td></tr></table></figure></p>
<h4 id="Filter聚合"><a href="#Filter聚合" class="headerlink" title="Filter聚合"></a>Filter聚合</h4><p>对当前环境的所有文档定义一个符合指定过滤条件的桶，常用来缩小当前聚合文档，得到一个符合特定条件的子文档集。<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"aggs"</span> : &#123;</div><div class="line">        <span class="attr">"red_products"</span> : &#123;</div><div class="line">            <span class="attr">"filter"</span> : &#123; <span class="attr">"term"</span>: &#123; <span class="attr">"color"</span>: <span class="string">"red"</span> &#125; &#125;,</div><div class="line">            <span class="attr">"aggs"</span> : &#123;</div><div class="line">                <span class="attr">"avg_price"</span> : &#123; <span class="attr">"avg"</span> : &#123; <span class="attr">"field"</span> : <span class="string">"price"</span> &#125; &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>结果如下：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    "aggs" : &#123;</div><div class="line">        "red_products" : &#123;</div><div class="line">            "doc_count" : 100,</div><div class="line">            "avg_price" : &#123; "value" : 56.3 &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在上面的例子中，计算所有红色商品的平均价格。</p>
<p>Java示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">AggregationBuilders.filter(<span class="string">"agg"</span>).filter(QueryBuilders.termQuery(<span class="string">"gender"</span>, <span class="string">"male"</span>));</div><div class="line">...</div><div class="line">Filter agg = searchResponse.getAggregations().get(<span class="string">"agg"</span>);</div><div class="line">agg.getDocCount(); <span class="comment">// Doc count</span></div></pre></td></tr></table></figure></p>
<h4 id="Filters聚合"><a href="#Filters聚合" class="headerlink" title="Filters聚合"></a>Filters聚合</h4><p>定义一个多桶聚合，每一个桶关联一个过滤器，每一个桶都从符合查询条件文档中收集符合关联过滤器的文档（原文说是从所有文档中收集符合关联过滤器条件文档，测试时发现是从符合查询条件的结果中收集，<a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.4/search-aggregations-bucket-filters-aggregation.html" target="_blank" rel="external">原文说明</a>）<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"aggs"</span> : &#123;</div><div class="line">    <span class="attr">"messages"</span> : &#123;</div><div class="line">      <span class="attr">"filters"</span> : &#123;</div><div class="line">        <span class="attr">"filters"</span> : &#123;</div><div class="line">          <span class="attr">"errors"</span> :   &#123; <span class="attr">"term"</span> : &#123; <span class="attr">"body"</span> : <span class="string">"error"</span>   &#125;&#125;,</div><div class="line">          <span class="attr">"warnings"</span> : &#123; <span class="attr">"term"</span> : &#123; <span class="attr">"body"</span> : <span class="string">"warning"</span> &#125;&#125;</div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      <span class="attr">"aggs"</span> : &#123;</div><div class="line">        <span class="attr">"monthly"</span> : &#123;</div><div class="line">          <span class="attr">"histogram"</span> : &#123;</div><div class="line">            <span class="attr">"field"</span> : <span class="string">"timestamp"</span>,</div><div class="line">            <span class="attr">"interval"</span> : <span class="string">"1M"</span></div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">  "aggs" : &#123;</div><div class="line">    "messages" : &#123;</div><div class="line">      "buckets" : &#123;</div><div class="line">        "errors" : &#123;</div><div class="line">          "doc_count" : 34,</div><div class="line">          "monthly" : &#123;</div><div class="line">            "buckets" : [</div><div class="line">              ... // the histogram monthly breakdown</div><div class="line">            ]</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        "warnings" : &#123;</div><div class="line">          "doc_count" : 439,</div><div class="line">          "monthly" : &#123;</div><div class="line">            "buckets" : [</div><div class="line">               ... // the histogram monthly breakdown</div><div class="line">            ]</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>在上面分析日志信息的示例中，聚合器会对日志信息建立两个集合(桶),一个包含所有的错误日志，一个包含所有的警告日志，然后对每一个桶都根据日期进行再分组。</p>
<p>也可以使用数组,注意返回格式的不同。<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"aggs"</span> : &#123;</div><div class="line">    <span class="attr">"messages"</span> : &#123;</div><div class="line">      <span class="attr">"filters"</span> : &#123;</div><div class="line">        <span class="attr">"filters"</span> : [</div><div class="line">          &#123; <span class="attr">"term"</span> : &#123; <span class="attr">"body"</span> : <span class="string">"error"</span>   &#125;&#125;,</div><div class="line">          &#123; <span class="attr">"term"</span> : &#123; <span class="attr">"body"</span> : <span class="string">"warning"</span> &#125;&#125;</div><div class="line">        ]</div><div class="line">      &#125;,</div><div class="line">      <span class="attr">"aggs"</span> : &#123;</div><div class="line">        <span class="attr">"monthly"</span> : &#123;</div><div class="line">          <span class="attr">"histogram"</span> : &#123;</div><div class="line">            <span class="attr">"field"</span> : <span class="string">"timestamp"</span>,</div><div class="line">            <span class="attr">"interval"</span> : <span class="string">"1M"</span></div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">  "aggs" : &#123;</div><div class="line">    "messages" : &#123;</div><div class="line">      "buckets" : [</div><div class="line">        &#123;</div><div class="line">          "doc_count" : 34,</div><div class="line">          "monthly" : &#123;</div><div class="line">            "buckets : [</div><div class="line">              ... // the histogram monthly breakdown</div><div class="line">            ]</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          "doc_count" : 439,</div><div class="line">          "monthly" : &#123;</div><div class="line">            "buckets : [</div><div class="line">              ... // the histogram monthly breakdown</div><div class="line">            ]</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>other_bucket参数：</p>
<p>other_bucket参数是一个Boolean值，默认false。如果为true，为返回结果添加一个包含所有文档(<em>这里所有文档是指符合查询条件的文档</em>)中不符合过滤条件的桶。与other_bucket参数配合的还有一个other_bucket_key参数，这个参数是为这个桶指定一个别名，默认名称是<em>other</em>，如果指定了other_bucket_key参数，则隐式指定other_bucket参数为true。<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"query"</span>: &#123;</div><div class="line">    <span class="attr">"wildcard"</span>: &#123;</div><div class="line">      <span class="attr">"name"</span>: <span class="string">"test*"</span></div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"aggs"</span>: &#123;</div><div class="line">    <span class="attr">"all_products"</span>: &#123;</div><div class="line">      <span class="attr">"filters"</span>: &#123;</div><div class="line">        <span class="attr">"other_bucket_key"</span>: <span class="string">"other_messages"</span>,</div><div class="line">        <span class="attr">"filters"</span>: &#123;</div><div class="line">          <span class="attr">"prefix_test222"</span>: &#123;</div><div class="line">            <span class="attr">"wildcard"</span>: &#123;</div><div class="line">              <span class="attr">"name"</span>: <span class="string">"test222*"</span></div><div class="line">            &#125;</div><div class="line">          &#125;,</div><div class="line">          <span class="attr">"id_1"</span>: &#123;</div><div class="line">            <span class="attr">"term"</span>: &#123;</div><div class="line">              <span class="attr">"id"</span>: <span class="string">"2"</span></div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"took"</span>: <span class="number">35</span>,</div><div class="line">    <span class="string">"timed_out"</span>: <span class="literal">false</span>,</div><div class="line">    <span class="string">"_shards"</span>: &#123;</div><div class="line">        <span class="string">"total"</span>: <span class="number">5</span>,</div><div class="line">        <span class="string">"successful"</span>: <span class="number">5</span>,</div><div class="line">        <span class="string">"failed"</span>: <span class="number">0</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"hits"</span>: &#123;</div><div class="line">        <span class="string">"total"</span>: <span class="number">2</span>,</div><div class="line">        <span class="string">"max_score"</span>: <span class="number">1</span>,</div><div class="line">        <span class="string">"hits"</span>: [                       <span class="comment">//符合查询条件的文档</span></div><div class="line">            &#123;</div><div class="line">                <span class="string">"_index"</span>: <span class="string">"radiott"</span>,</div><div class="line">                <span class="string">"_type"</span>: <span class="string">"artiststt"</span>,</div><div class="line">                <span class="string">"_id"</span>: <span class="string">"AVx7JhglJRLJihedvp1b"</span>,</div><div class="line">                <span class="string">"_score"</span>: <span class="number">1</span>,</div><div class="line">                <span class="string">"_source"</span>: &#123;</div><div class="line">                    <span class="string">"name"</span>: <span class="string">"test333"</span>,</div><div class="line">                    <span class="string">"id"</span>: <span class="string">"3"</span></div><div class="line">                &#125;</div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                <span class="string">"_index"</span>: <span class="string">"radiott"</span>,</div><div class="line">                <span class="string">"_type"</span>: <span class="string">"artiststt"</span>,</div><div class="line">                <span class="string">"_id"</span>: <span class="string">"AVw0PAb_xJt8Zgd-WGNi"</span>,</div><div class="line">                <span class="string">"_score"</span>: <span class="number">1</span>,</div><div class="line">                <span class="string">"_source"</span>: &#123;</div><div class="line">                    <span class="string">"id"</span>: <span class="string">"2"</span>,</div><div class="line">                    <span class="string">"name"</span>: <span class="string">"test222"</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        ]</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"aggregations"</span>: &#123;                   <span class="comment">//聚合</span></div><div class="line">        <span class="string">"all_products"</span>: &#123;</div><div class="line">            <span class="string">"buckets"</span>: &#123;</div><div class="line">                <span class="string">"prefix_test222"</span>: &#123;     <span class="comment">//前缀为test222的数量</span></div><div class="line">                    <span class="string">"doc_count"</span>: <span class="number">1</span></div><div class="line">                &#125;,</div><div class="line">                <span class="string">"id_1"</span>: &#123;               <span class="comment">//id为1的数量</span></div><div class="line">                    <span class="string">"doc_count"</span>: <span class="number">1</span></div><div class="line">                &#125;,</div><div class="line">                <span class="string">"other_messages"</span>: &#123;     <span class="comment">//其它文档的数量</span></div><div class="line">                    <span class="string">"doc_count"</span>: <span class="number">1</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在上面的示例中，查询name字段所有以test开头的文档，查询结果共3条数据，在过滤聚合中分别统计前缀以test222开头、id为1和其它文档的数量。</p>
<p>Java使用示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">AggregationBuilder aggregation =</div><div class="line">    AggregationBuilders</div><div class="line">        .filters(<span class="string">"agg"</span>)</div><div class="line">            .filter(<span class="string">"men"</span>, QueryBuilders.termQuery(<span class="string">"gender"</span>, <span class="string">"male"</span>))</div><div class="line">            .filter(<span class="string">"women"</span>, QueryBuilders.termQuery(<span class="string">"gender"</span>, <span class="string">"female"</span>));</div><div class="line">            </div><div class="line">...</div><div class="line">Filters agg = searchResponse.getAggregations().get(<span class="string">"agg"</span>);</div><div class="line"></div><div class="line"><span class="keyword">for</span> (Filters.Bucket entry : agg.getBuckets()) &#123;</div><div class="line">    String key = entry.getKeyAsString();            <span class="comment">// bucket key</span></div><div class="line">    <span class="keyword">long</span> docCount = entry.getDocCount();            <span class="comment">// Doc count</span></div><div class="line">    logger.info(<span class="string">"key [&#123;&#125;], doc_count [&#123;&#125;]"</span>, key, docCount);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">key [men], doc_count [4982]</div><div class="line">key [women], doc_count [5018]</div></pre></td></tr></table></figure></p>
<h4 id="Missing聚合"><a href="#Missing聚合" class="headerlink" title="Missing聚合"></a>Missing聚合</h4><p>一个基于字段值的单桶聚合器，统计当前查询文档中指定字段没有字段值的文档(通常是null),该聚合器通常同其它基于字段值聚合器一起使用(如range聚合器),它不能放在其它聚合器里面，因为该聚合器统计的字段值为空。<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"aggs"</span>: &#123;</div><div class="line">    <span class="attr">"miss_value"</span>: &#123;</div><div class="line">      <span class="attr">"missing"</span>: &#123;</div><div class="line">        <span class="attr">"field"</span>: <span class="string">"name"</span></div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"aggregations"</span>: &#123;</div><div class="line">        <span class="attr">"miss_value"</span>: &#123;</div><div class="line">            <span class="attr">"doc_count"</span>: <span class="number">2</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>java使用示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">AggregationBuilders.missing(<span class="string">"agg"</span>).field(<span class="string">"gender"</span>);</div><div class="line">...</div><div class="line">Missing agg = searchResponse.getAggregations().get(<span class="string">"agg"</span>);</div><div class="line">agg.getDocCount();</div></pre></td></tr></table></figure></p>
<h4 id="Nested聚合"><a href="#Nested聚合" class="headerlink" title="Nested聚合"></a>Nested聚合</h4><p>一个特殊的但桶聚合器能够聚合嵌套文档。</p>
<p>例如，我们有一个所有商品的索引，每个商品都维护一个所有经销商的列表，每个经销商都有该商品的价格，结构如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    <span class="string">"product"</span> : &#123;</div><div class="line">        <span class="string">"properties"</span> : &#123;</div><div class="line">            <span class="string">"resellers"</span> : &#123; <span class="comment">//经销商，这是一个数组</span></div><div class="line">                <span class="string">"type"</span> : <span class="string">"nested"</span>,</div><div class="line">                <span class="string">"properties"</span> : &#123;</div><div class="line">                    <span class="string">"name"</span> : &#123; <span class="string">"type"</span> : <span class="string">"string"</span> &#125;, <span class="comment">//经销商名称</span></div><div class="line">                    <span class="string">"price"</span> : &#123; <span class="string">"type"</span> : <span class="string">"double"</span> &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>取出所有商品的最低价格<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"query"</span> : &#123;</div><div class="line">        <span class="attr">"match"</span> : &#123; <span class="attr">"name"</span> : <span class="string">"led tv"</span> &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"aggs"</span> : &#123;</div><div class="line">        <span class="attr">"resellers"</span> : &#123;</div><div class="line">            <span class="attr">"nested"</span> : &#123;</div><div class="line">                <span class="attr">"path"</span> : <span class="string">"resellers"</span></div><div class="line">            &#125;,</div><div class="line">            <span class="attr">"aggs"</span> : &#123;</div><div class="line">                <span class="attr">"min_price"</span> : &#123; <span class="attr">"min"</span> : &#123; <span class="attr">"field"</span> : <span class="string">"resellers.price"</span> &#125; &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"aggregations"</span>: &#123;</div><div class="line">        <span class="attr">"resellers"</span>: &#123;</div><div class="line">            <span class="attr">"min_price"</span>: &#123;</div><div class="line">                <span class="attr">"value"</span> : <span class="number">350</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>java 使用示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">AggregationBuilders.nested(<span class="string">"agg"</span>).path(<span class="string">"resellers"</span>);</div><div class="line">...</div><div class="line">Nested agg = searchResponse.getAggregations().get(<span class="string">"agg"</span>);</div><div class="line">agg.getDocCount(); <span class="comment">// Doc count</span></div></pre></td></tr></table></figure></p>
<h4 id="Reerse-nested聚合"><a href="#Reerse-nested聚合" class="headerlink" title="Reerse nested聚合"></a>Reerse nested聚合</h4><p>暂时没看懂<a href="https://www.elastic.co/guide/en/elasticsearch/client/java-api/2.4/_bucket_aggregations.html#java-aggs-bucket-reverse-nested" target="_blank" rel="external">官方文档</a></p>
<h4 id="Children聚合"><a href="#Children聚合" class="headerlink" title="Children聚合"></a>Children聚合</h4><p>一种特殊的单桶聚合器，能够从父文档类型的桶聚合到子文档类型的桶。该聚合依赖<a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.4/mapping-parent-field.html" target="_blank" rel="external">_parent字段</a>，有一个type选项。</p>
<ul>
<li>type：子文档需要关联的父文档的类型。例如，一个索引中有question和answer两个类型,answer类型必须有一个_parent字段。<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"answer"</span> : &#123;</div><div class="line">        <span class="attr">"_parent"</span> : &#123;</div><div class="line">            <span class="attr">"type"</span> : <span class="string">"question"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>questions类型文档有一个tags字段，answer类型文档有一个owner字段。在一个请求中，使用children聚合，tags桶能够关联到owner桶，即便两个字段存在于不同类型的文档中。</p>
<p>一个question文档片段<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"body"</span>: <span class="string">"&lt;p&gt;I have Windows 2003 server and i bought a new Windows 2008 server..."</span>,</div><div class="line">    <span class="attr">"title"</span>: <span class="string">"Whats the best way to file transfer my site from server to a newer one?"</span>,</div><div class="line">    <span class="attr">"tags"</span>: [</div><div class="line">        <span class="string">"windows-server-2003"</span>,</div><div class="line">        <span class="string">"windows-server-2008"</span>,</div><div class="line">        <span class="string">"file-transfer"</span></div><div class="line">    ],</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>一个answer文档片段<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"owner"</span>: &#123;</div><div class="line">        <span class="attr">"location"</span>: <span class="string">"Norfolk, United Kingdom"</span>,</div><div class="line">        <span class="attr">"display_name"</span>: <span class="string">"Sam"</span>,</div><div class="line">        <span class="attr">"id"</span>: <span class="number">48</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"body"</span>: <span class="string">"&lt;p&gt;Unfortunately your pretty much limited to FTP..."</span>,</div><div class="line">    <span class="attr">"creation_date"</span>: <span class="string">"2009-05-04T13:45:37.030"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>请求如下：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"aggs"</span>: &#123;</div><div class="line">    <span class="attr">"top-tags"</span>: &#123;</div><div class="line">      <span class="attr">"terms"</span>: &#123;</div><div class="line">        <span class="attr">"field"</span>: <span class="string">"tags"</span>,</div><div class="line">        <span class="attr">"size"</span>: <span class="number">10</span></div><div class="line">      &#125;,</div><div class="line">      <span class="attr">"aggs"</span>: &#123;</div><div class="line">        <span class="attr">"to-answers"</span>: &#123;</div><div class="line">          <span class="attr">"children"</span>: &#123;</div><div class="line">            <span class="attr">"type"</span> : <span class="string">"answer"</span> </div><div class="line">          &#125;,</div><div class="line">          <span class="attr">"aggs"</span>: &#123;</div><div class="line">            <span class="attr">"top-names"</span>: &#123;</div><div class="line">              <span class="attr">"terms"</span>: &#123;</div><div class="line">                <span class="attr">"field"</span>: <span class="string">"owner.display_name"</span>,</div><div class="line">                <span class="attr">"size"</span>: <span class="number">10</span></div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最终返回的结果<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"aggregations"</span>: &#123;</div><div class="line">    <span class="string">"top-tags"</span>: &#123;</div><div class="line">      <span class="string">"buckets"</span>: [</div><div class="line">        &#123;</div><div class="line">          <span class="string">"key"</span>: <span class="string">"windows-server-2003"</span>,</div><div class="line">          <span class="string">"doc_count"</span>: <span class="number">25365</span>,   <span class="comment">//含有标签“windows-server-2003”的文档数</span></div><div class="line">          <span class="string">"to-answers"</span>: &#123;</div><div class="line">            <span class="string">"doc_count"</span>: <span class="number">36004</span>,     <span class="comment">//含有标签“windows-server-2003”的问题的答案数量</span></div><div class="line">            <span class="string">"top-names"</span>: &#123;</div><div class="line">              <span class="string">"buckets"</span>: [</div><div class="line">                &#123;</div><div class="line">                  <span class="string">"key"</span>: <span class="string">"Sam"</span>,</div><div class="line">                  <span class="string">"doc_count"</span>: <span class="number">274</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                  <span class="string">"key"</span>: <span class="string">"chris"</span>,</div><div class="line">                  <span class="string">"doc_count"</span>: <span class="number">19</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                  <span class="string">"key"</span>: <span class="string">"david"</span>,</div><div class="line">                  <span class="string">"doc_count"</span>: <span class="number">14</span></div><div class="line">                &#125;,</div><div class="line">                ...</div><div class="line">              ]</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;,</div><div class="line">        ...</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Java示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">AggregationBuilder aggregation = AggregationBuilders</div><div class="line">        .children(<span class="string">"agg"</span>)</div><div class="line">        .childType(<span class="string">"reseller"</span>);</div><div class="line">...</div><div class="line">Children agg = searchResponse.getAggregations().get(<span class="string">"agg"</span>);</div><div class="line">agg.getDocCount();</div></pre></td></tr></table></figure></p>
<h4 id="Terms聚合"><a href="#Terms聚合" class="headerlink" title="Terms聚合"></a>Terms聚合</h4><p>基于文档动态建立的包含多个桶的聚合，每个桶包含一个独一无二的值。文档感觉有点拗口，实质就是针对指定字段，对该字段的重复值计算数量。<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"aggs"</span> : &#123;</div><div class="line">        <span class="attr">"genres"</span> : &#123;</div><div class="line">            <span class="attr">"terms"</span> : &#123; <span class="attr">"field"</span> : <span class="string">"genre"</span> &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    <span class="string">"aggregations"</span> : &#123;</div><div class="line">        <span class="string">"genres"</span> : &#123;</div><div class="line">            <span class="string">"doc_count_error_upper_bound"</span>: <span class="number">0</span>, <span class="comment">//对文档每个term计算过程中发生的错误的上界</span></div><div class="line">            </div><div class="line">            <span class="string">"sum_other_doc_count"</span>: <span class="number">0</span>,   <span class="comment">//当文档有很多非重复值，elasticsearch只会返回排在前面的几个terms，这个数字就是未返回的terms的总数</span></div><div class="line">            <span class="string">"buckets"</span> : [ </div><div class="line">                &#123;</div><div class="line">                    <span class="string">"key"</span> : <span class="string">"jazz"</span>,</div><div class="line">                    <span class="string">"doc_count"</span> : <span class="number">10</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                    <span class="string">"key"</span> : <span class="string">"rock"</span>,</div><div class="line">                    <span class="string">"doc_count"</span> : <span class="number">10</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                    <span class="string">"key"</span> : <span class="string">"electronic"</span>,</div><div class="line">                    <span class="string">"doc_count"</span> : <span class="number">10</span></div><div class="line">                &#125;,</div><div class="line">            ]</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>size参数</li>
</ul>
<p>默认情况下，terms聚合会根据doc_count数量排序并返回排在前面的terms，可以修改size参数改变返回的数量。假如size=5，在处理size过程中，节点会协调查询过程请求每个分片返回前5个terms，组合每个分片返回的 terms到一个列表中并排序，再返回列表中的前5个terms到客户端。如果每个分片的terms数量大于5，最终返回的实际结果会有一些偏差。实际结果并不精确。</p>
<blockquote>
<p>注意：在2.4.0版本以前，设置size=0，实际会被处理成size=Integer.MAX_VALUE,在后续版本中已经废弃，将来会被移除。</p>
</blockquote>
<ul>
<li><p>shard_size 参数<br>指定每个分片返回的size数量，能够在一定程度上提升数据的准确性，但这会加大资源的消耗(CPU、节点间数据传输消耗等等)。</p>
<blockquote>
<p>注意：shard_size值不能比size小，如果设置的值比size小，elasticsearch会用size的值覆盖。</p>
</blockquote>
</li>
<li><p>order 参数</p>
</li>
</ul>
<p>默认情况下，根据doc_count降序排列</p>
<blockquote>
<p>注意：最好不要修改根据doc_count升序排列，这会加大错误的数量。</p>
</blockquote>
<p>根据doc_count升序排列<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"aggs"</span> : &#123;</div><div class="line">        <span class="attr">"genres"</span> : &#123;</div><div class="line">            <span class="attr">"terms"</span> : &#123;</div><div class="line">                <span class="attr">"field"</span> : <span class="string">"genre"</span>,</div><div class="line">                <span class="attr">"order"</span> : &#123; <span class="attr">"_count"</span> : <span class="string">"asc"</span> &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>根据字母顺序升序<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">"order" : &#123; "_term" : "asc" &#125;</div></pre></td></tr></table></figure></p>
<p>根据单值Metris子聚合排列(根据聚合名称识别)<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"aggs"</span> : &#123;</div><div class="line">        <span class="attr">"genres"</span> : &#123;</div><div class="line">            <span class="attr">"terms"</span> : &#123;</div><div class="line">                <span class="attr">"field"</span> : <span class="string">"genre"</span>,</div><div class="line">                <span class="attr">"order"</span> : &#123; <span class="attr">"avg_play_count"</span> : <span class="string">"desc"</span> &#125;</div><div class="line">            &#125;,</div><div class="line">            <span class="attr">"aggs"</span> : &#123;</div><div class="line">                <span class="attr">"avg_play_count"</span> : &#123; <span class="attr">"avg"</span> : &#123; <span class="attr">"field"</span> : <span class="string">"play_count"</span> &#125; &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>根据单多值Metris子聚合排列(根据聚合名称识别)<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"aggs"</span> : &#123;</div><div class="line">        <span class="attr">"genres"</span> : &#123;</div><div class="line">            <span class="attr">"terms"</span> : &#123;</div><div class="line">                <span class="attr">"field"</span> : <span class="string">"genre"</span>,</div><div class="line">                <span class="attr">"order"</span> : &#123; <span class="attr">"playback_stats.avg"</span> : <span class="string">"desc"</span> &#125;</div><div class="line">            &#125;,</div><div class="line">            <span class="attr">"aggs"</span> : &#123;</div><div class="line">                <span class="attr">"playback_stats"</span> : &#123; <span class="attr">"stats"</span> : &#123; <span class="attr">"field"</span> : <span class="string">"play_count"</span> &#125; &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>注意：Pipeline聚合不能用于排序</p>
</blockquote>
<ul>
<li>min_doc_count 参数</li>
</ul>
<p>没看懂，参考<a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.4/search-aggregations-bucket-terms-aggregation.html#_minimum_document_count_3" target="_blank" rel="external">官方文档</a></p>
<p>java示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">AggregationBuilders.terms(<span class="string">"genders"</span>).field(<span class="string">"gender"</span>)</div><div class="line">    <span class="comment">//下面是几种排序方式</span></div><div class="line">    .order(Terms.Order.count(<span class="keyword">true</span>))</div><div class="line">    </div><div class="line">    <span class="comment">//.order(Terms.Order.term(true))</span></div><div class="line">    </div><div class="line">    <span class="comment">//.order(Terms.Order.aggregation("avg_height", false))</span></div><div class="line">    <span class="comment">//.subAggregation(</span></div><div class="line">    <span class="comment">//    AggregationBuilders.avg("avg_height").field("height")</span></div><div class="line">    <span class="comment">//)</span></div><div class="line">...</div><div class="line">Terms genders = searchResponse.getAggregations().get(<span class="string">"genders"</span>);</div><div class="line"><span class="keyword">for</span> (Terms.Bucket entry : genders.getBuckets()) &#123;</div><div class="line">    entry.getKey();      <span class="comment">// Term</span></div><div class="line">    entry.getDocCount(); <span class="comment">// Doc count</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Significant-Terms聚合"><a href="#Significant-Terms聚合" class="headerlink" title="Significant Terms聚合"></a>Significant Terms聚合</h4><p>返回感兴趣或者异常发生的terms。在数据量很大的索引中， Significant Terms聚合会很重。使用场景如下：</p>
<ul>
<li>在搜索禽流感时建议”H5N1”</li>
<li>在新闻自动化分类中建议关于ATI公司股票的关键字</li>
<li>找出轮胎制造商不成比例的爆胎数量</li>
</ul>
<p><strong>单结果集分析</strong><br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"query"</span> : &#123;</div><div class="line">        <span class="attr">"terms"</span> : &#123;<span class="attr">"force"</span> : [ <span class="string">"British Transport Police"</span> ]&#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"aggregations"</span> : &#123;</div><div class="line">        <span class="attr">"significantCrimeTypes"</span> : &#123;</div><div class="line">            <span class="attr">"significant_terms"</span> : &#123; <span class="attr">"field"</span> : <span class="string">"crime_type"</span> &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    <span class="string">"aggregations"</span> : &#123;</div><div class="line">        <span class="string">"significantCrimeTypes"</span> : &#123;</div><div class="line">            <span class="string">"doc_count"</span>: <span class="number">47347</span>,     <span class="comment">//伦敦交警局的犯罪总数量</span></div><div class="line">            <span class="string">"buckets"</span> : [</div><div class="line">                &#123;</div><div class="line">                    <span class="string">"key"</span>: <span class="string">"Bicycle theft"</span>,</div><div class="line">                    <span class="string">"doc_count"</span>: <span class="number">3640</span>,  <span class="comment">//伦敦交警局的自行车犯罪总数量</span></div><div class="line">                    <span class="string">"score"</span>: <span class="number">0.371235374214817</span>,</div><div class="line">                    <span class="string">"bg_count"</span>: <span class="number">66799</span>   <span class="comment">//所有警局的自行车偷盗犯罪总数量</span></div><div class="line">                &#125;</div><div class="line">                ...</div><div class="line">            ]</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从所有警局中查询犯罪记录，上面显示了伦敦交警处理的大量的不成比例的自行车偷盗犯罪。在一般情况下，自行车偷盗犯罪在所有犯罪中仅占1%(66799/5064554)，而伦敦交警的工作范围仅仅在地铁和车站，自行车偷盗犯罪就占7%(3640/47347)。</p>
<p><strong>多结果集分析</strong></p>
<p>如果要对多个分类进行分析，一个简单的方式是先使用父聚合分割数据，在进行分析。<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"aggregations"</span>: &#123;</div><div class="line">        <span class="attr">"forces"</span>: &#123;</div><div class="line">            <span class="attr">"terms"</span>: &#123;<span class="attr">"field"</span>: <span class="string">"force"</span>&#125;,</div><div class="line">            <span class="attr">"aggregations"</span>: &#123;</div><div class="line">                <span class="attr">"significantCrimeTypes"</span>: &#123;</div><div class="line">                    <span class="attr">"significant_terms"</span>: &#123;<span class="attr">"field"</span>: <span class="string">"crime_type"</span>&#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line"> ...</div><div class="line"></div><div class="line"> <span class="string">"aggregations"</span>: &#123;</div><div class="line">    <span class="string">"forces"</span>: &#123;</div><div class="line">        <span class="string">"buckets"</span>: [</div><div class="line">            &#123;</div><div class="line">                <span class="string">"key"</span>: <span class="string">"Metropolitan Police Service"</span>,</div><div class="line">                <span class="string">"doc_count"</span>: <span class="number">894038</span>,</div><div class="line">                <span class="string">"significantCrimeTypes"</span>: &#123;</div><div class="line">                    <span class="string">"doc_count"</span>: <span class="number">894038</span>,</div><div class="line">                    <span class="string">"buckets"</span>: [</div><div class="line">                        &#123;</div><div class="line">                            <span class="string">"key"</span>: <span class="string">"Robbery"</span>,</div><div class="line">                            <span class="string">"doc_count"</span>: <span class="number">27617</span>,</div><div class="line">                            <span class="string">"score"</span>: <span class="number">0.0599</span>,</div><div class="line">                            <span class="string">"bg_count"</span>: <span class="number">53182</span></div><div class="line">                        &#125;,</div><div class="line">                        ...</div><div class="line">                    ]</div><div class="line">                &#125;</div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                <span class="string">"key"</span>: <span class="string">"British Transport Police"</span>,</div><div class="line">                <span class="string">"doc_count"</span>: <span class="number">47347</span>,</div><div class="line">                <span class="string">"significantCrimeTypes"</span>: &#123;</div><div class="line">                    <span class="string">"doc_count"</span>: <span class="number">47347</span>,</div><div class="line">                    <span class="string">"buckets"</span>: [</div><div class="line">                        &#123;</div><div class="line">                            <span class="string">"key"</span>: <span class="string">"Bicycle theft"</span>,</div><div class="line">                            <span class="string">"doc_count"</span>: <span class="number">3640</span>,</div><div class="line">                            <span class="string">"score"</span>: <span class="number">0.371</span>,</div><div class="line">                            <span class="string">"bg_count"</span>: <span class="number">66799</span></div><div class="line">                        &#125;,</div><div class="line">                        ...</div><div class="line">                    ]</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        ]</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的示例展示了分别对各个警局的异常犯罪进行分析。</p>
<p>同样的也可以使用其它父聚合分割数据再进行分析，如通过地理位置分析不同类型犯罪的热点区域。<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"aggs"</span>: &#123;</div><div class="line">        <span class="attr">"hotspots"</span>: &#123;</div><div class="line">            <span class="attr">"geohash_grid"</span> : &#123;</div><div class="line">                <span class="attr">"field"</span>:<span class="string">"location"</span>,</div><div class="line">                <span class="attr">"precision"</span>:<span class="number">5</span>,</div><div class="line">            &#125;,</div><div class="line">            <span class="attr">"aggs"</span>: &#123;</div><div class="line">                <span class="attr">"significantCrimeTypes"</span>: &#123;</div><div class="line">                    <span class="attr">"significant_terms"</span>: &#123;<span class="attr">"field"</span>: <span class="string">"crime_type"</span>&#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个例子使用<strong>geohash_grid聚合</strong>创建地理位置区域的桶然后在每个桶中再对犯罪类型进行分析。</p>
<blockquote>
<p>更多详细说明参见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.4/search-aggregations-bucket-significantterms-aggregation.html" target="_blank" rel="external">官方文档</a></p>
</blockquote>
<p>Java使用示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">AggregationBuilder aggregation = AggregationBuilders</div><div class="line">                .significantTerms(<span class="string">"significant_countries"</span>)</div><div class="line">                .field(<span class="string">"address.country"</span>);</div><div class="line"></div><div class="line"><span class="comment">// Let say you search for men only</span></div><div class="line">SearchResponse sr = client.prepareSearch()</div><div class="line">        .setQuery(QueryBuilders.termQuery(<span class="string">"gender"</span>, <span class="string">"male"</span>))</div><div class="line">        .addAggregation(aggregation)</div><div class="line">        .get();</div><div class="line">...</div><div class="line">SignificantTerms agg = sr.getAggregations().get(<span class="string">"significant_countries"</span>);</div><div class="line"><span class="keyword">for</span> (SignificantTerms.Bucket entry : agg.getBuckets()) &#123;</div><div class="line">    entry.getKey();      <span class="comment">// Term</span></div><div class="line">    entry.getDocCount(); <span class="comment">// Doc count</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Range聚合"><a href="#Range聚合" class="headerlink" title="Range聚合"></a>Range聚合</h4><p>基于多桶数据集的聚合，它能够为每一个桶定义范围。在聚合过程中，从每一个文档中提取的值都将和桶的范围进行比较，然后统计到对应的桶中。在比较边界数据时包含下界不包含上界，即包含from的值不包含to的值。<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"aggs"</span> : &#123;</div><div class="line">        <span class="attr">"price_ranges"</span> : &#123;</div><div class="line">            <span class="attr">"range"</span> : &#123;</div><div class="line">                <span class="attr">"field"</span> : <span class="string">"price"</span>,</div><div class="line">                <span class="attr">"ranges"</span> : [</div><div class="line">                    &#123; <span class="attr">"to"</span> : <span class="number">50</span> &#125;,</div><div class="line">                    &#123; <span class="attr">"from"</span> : <span class="number">50</span>, <span class="attr">"to"</span> : <span class="number">100</span> &#125;,</div><div class="line">                    &#123; <span class="attr">"from"</span> : <span class="number">100</span> &#125;</div><div class="line">                ]</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="string">"aggregations"</span>: &#123;</div><div class="line">        <span class="string">"price_ranges"</span> : &#123;</div><div class="line">            <span class="string">"buckets"</span>: [</div><div class="line">                &#123;</div><div class="line">                    <span class="string">"to"</span>: <span class="number">50</span>,</div><div class="line">                    <span class="string">"doc_count"</span>: <span class="number">2</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                    <span class="string">"from"</span>: <span class="number">50</span>,</div><div class="line">                    <span class="string">"to"</span>: <span class="number">100</span>,</div><div class="line">                    <span class="string">"doc_count"</span>: <span class="number">4</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                    <span class="string">"from"</span>: <span class="number">100</span>,</div><div class="line">                    <span class="string">"doc_count"</span>: <span class="number">4</span></div><div class="line">                &#125;</div><div class="line">            ]</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>设置key:true参数key为每一个桶设置一个名字<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"aggs"</span> : &#123;</div><div class="line">        <span class="attr">"price_ranges"</span> : &#123;</div><div class="line">            <span class="attr">"range"</span> : &#123;</div><div class="line">                <span class="attr">"field"</span> : <span class="string">"price"</span>,</div><div class="line">                <span class="attr">"keyed"</span> : <span class="literal">true</span>,</div><div class="line">                <span class="attr">"ranges"</span> : [</div><div class="line">                    &#123; <span class="attr">"to"</span> : <span class="number">50</span> &#125;,</div><div class="line">                    &#123; <span class="attr">"from"</span> : <span class="number">50</span>, <span class="attr">"to"</span> : <span class="number">100</span> &#125;,</div><div class="line">                    &#123; <span class="attr">"from"</span> : <span class="number">100</span> &#125;</div><div class="line">                ]</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    <span class="string">"aggregations"</span>: &#123;</div><div class="line">        <span class="string">"price_ranges"</span> : &#123;</div><div class="line">            <span class="string">"buckets"</span>: &#123;</div><div class="line">                <span class="string">"*-50.0"</span>: &#123;</div><div class="line">                    <span class="string">"to"</span>: <span class="number">50</span>,</div><div class="line">                    <span class="string">"doc_count"</span>: <span class="number">2</span></div><div class="line">                &#125;,</div><div class="line">                <span class="string">"50.0-100.0"</span>: &#123;</div><div class="line">                    <span class="string">"from"</span>: <span class="number">50</span>,</div><div class="line">                    <span class="string">"to"</span>: <span class="number">100</span>,</div><div class="line">                    <span class="string">"doc_count"</span>: <span class="number">4</span></div><div class="line">                &#125;,</div><div class="line">                <span class="string">"100.0-*"</span>: &#123;</div><div class="line">                    <span class="string">"from"</span>: <span class="number">100</span>,</div><div class="line">                    <span class="string">"doc_count"</span>: <span class="number">4</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>也可以设置自定义名称<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"aggs"</span> : &#123;</div><div class="line">        <span class="attr">"price_ranges"</span> : &#123;</div><div class="line">            <span class="attr">"range"</span> : &#123;</div><div class="line">                <span class="attr">"field"</span> : <span class="string">"price"</span>,</div><div class="line">                <span class="attr">"keyed"</span> : <span class="literal">true</span>,</div><div class="line">                <span class="attr">"ranges"</span> : [</div><div class="line">                    &#123; <span class="attr">"key"</span> : <span class="string">"cheap"</span>, <span class="attr">"to"</span> : <span class="number">50</span> &#125;,</div><div class="line">                    &#123; <span class="attr">"key"</span> : <span class="string">"average"</span>, <span class="attr">"from"</span> : <span class="number">50</span>, <span class="attr">"to"</span> : <span class="number">100</span> &#125;,</div><div class="line">                    &#123; <span class="attr">"key"</span> : <span class="string">"expensive"</span>, <span class="attr">"from"</span> : <span class="number">100</span> &#125;</div><div class="line">                ]</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>更多关于script方式的使用参见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.4/search-aggregations-bucket-range-aggregation.html" target="_blank" rel="external">官方文档</a></p>
</blockquote>
<p>java使用示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">AggregationBuilder aggregation = AggregationBuilders</div><div class="line">                .range(<span class="string">"agg"</span>)</div><div class="line">                .field(<span class="string">"height"</span>)</div><div class="line">                .addUnboundedTo(<span class="number">1.0f</span>)               <span class="comment">// from -infinity to 1.0 (excluded)</span></div><div class="line">                .addRange(<span class="number">1.0f</span>, <span class="number">1.5f</span>)               <span class="comment">// from 1.0 to 1.5 (excluded)</span></div><div class="line">                .addUnboundedFrom(<span class="number">1.5f</span>);            <span class="comment">// from 1.5 to +infinity</span></div><div class="line">...</div><div class="line">Range agg = searchResponse.getAggregations().get(<span class="string">"agg"</span>);</div><div class="line"><span class="keyword">for</span> (Range.Bucket entry : agg.getBuckets()) &#123;</div><div class="line">    String key = entry.getKeyAsString();             <span class="comment">// Range as key</span></div><div class="line">    Number from = (Number) entry.getFrom();          <span class="comment">// Bucket from</span></div><div class="line">    Number to = (Number) entry.getTo();              <span class="comment">// Bucket to</span></div><div class="line">    <span class="keyword">long</span> docCount = entry.getDocCount();    <span class="comment">// Doc count</span></div><div class="line">    logger.info(<span class="string">"key [&#123;&#125;], from [&#123;&#125;], to [&#123;&#125;], doc_count [&#123;&#125;]"</span>, key, from, to, docCount);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>输出结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">key [*-1.0], from [-Infinity], to [1.0], doc_count [9]</div><div class="line">key [1.0-1.5], from [1.0], to [1.5], doc_count [21]</div><div class="line">key [1.5-*], from [1.5], to [Infinity], doc_count [20]</div></pre></td></tr></table></figure></p>
<h4 id="Date-Range聚合"><a href="#Date-Range聚合" class="headerlink" title="Date Range聚合"></a>Date Range聚合</h4><p>一个处理日期类型数据的聚合器，和range聚合器最大的不同是from和to的值可以是<a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.4/common-options.html#date-math" target="_blank" rel="external">Date Math</a>表达式,也可以设置返回结果需要转换的日期格式，桶range一样，日期比较时包含from不包含to。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"aggs"</span>: &#123;</div><div class="line">        <span class="string">"range"</span>: &#123;</div><div class="line">            <span class="string">"date_range"</span>: &#123;</div><div class="line">                <span class="string">"field"</span>: <span class="string">"date"</span>,</div><div class="line">                <span class="string">"format"</span>: <span class="string">"MM-yyy"</span>,</div><div class="line">                <span class="string">"ranges"</span>: [</div><div class="line">                    &#123; <span class="string">"to"</span>: <span class="string">"now-10M/M"</span> &#125;, <span class="comment">//当前时间减10个月，向下取整到月份开始的日期</span></div><div class="line">                    &#123; <span class="string">"from"</span>: <span class="string">"now-10M/M"</span> &#125; </div><div class="line">                ]</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"aggregations"</span>: &#123;</div><div class="line">        <span class="attr">"range"</span>: &#123;</div><div class="line">            <span class="attr">"buckets"</span>: [</div><div class="line">                &#123;</div><div class="line">                    <span class="attr">"to"</span>: <span class="number">1.3437792E+12</span>,</div><div class="line">                    <span class="attr">"to_as_string"</span>: <span class="string">"08-2012"</span>,</div><div class="line">                    <span class="attr">"doc_count"</span>: <span class="number">7</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                    <span class="attr">"from"</span>: <span class="number">1.3437792E+12</span>,</div><div class="line">                    <span class="attr">"from_as_string"</span>: <span class="string">"08-2012"</span>,</div><div class="line">                    <span class="attr">"doc_count"</span>: <span class="number">2</span></div><div class="line">                &#125;</div><div class="line">            ]</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>日期转换格式同基本的y,M,d,m,h/H,s一致，还有一些更精细的日期格式，详见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.4/search-aggregations-bucket-daterange-aggregation.html#date-format-pattern" target="_blank" rel="external">官方文档</a></p>
<p>java使用示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">AggregationBuilder aggregation = AggregationBuilders</div><div class="line">                .dateRange(<span class="string">"agg"</span>)</div><div class="line">                .field(<span class="string">"dateOfBirth"</span>)</div><div class="line">                .format(<span class="string">"yyyy"</span>)</div><div class="line">                .addUnboundedTo(<span class="string">"1950"</span>)    <span class="comment">// from -infinity to 1950 (excluded)</span></div><div class="line">                .addRange(<span class="string">"1950"</span>, <span class="string">"1960"</span>)  <span class="comment">// from 1950 to 1960 (excluded)</span></div><div class="line">                .addUnboundedFrom(<span class="string">"1960"</span>); <span class="comment">// from 1960 to +infinity</span></div><div class="line">...</div><div class="line">Range agg = searchResponse.getAggregations().get(<span class="string">"agg"</span>);</div><div class="line"><span class="keyword">for</span> (Range.Bucket entry : agg.getBuckets()) &#123;</div><div class="line">    String key = entry.getKeyAsString();                <span class="comment">// Date range as key</span></div><div class="line">    DateTime fromAsDate = (DateTime) entry.getFrom();   <span class="comment">// Date bucket from as a Date</span></div><div class="line">    DateTime toAsDate = (DateTime) entry.getTo();       <span class="comment">// Date bucket to as a Date</span></div><div class="line">    <span class="keyword">long</span> docCount = entry.getDocCount();                <span class="comment">// Doc count</span></div><div class="line">    logger.info(<span class="string">"key [&#123;&#125;], from [&#123;&#125;], to [&#123;&#125;], doc_count [&#123;&#125;]"</span>, key, fromAsDate, toAsDate, docCount);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">key [*-1950], from [null], to [1950-01-01T00:00:00.000Z], doc_count [8]</div><div class="line">key [1950-1960], from [1950-01-01T00:00:00.000Z], to [1960-01-01T00:00:00.000Z], doc_count [5]</div><div class="line">key [1960-*], from [1960-01-01T00:00:00.000Z], to [null], doc_count [37]</div></pre></td></tr></table></figure></p>
<h4 id="IPv4-Range-聚合"><a href="#IPv4-Range-聚合" class="headerlink" title="IPv4 Range 聚合"></a>IPv4 Range 聚合</h4><p>同date range聚合，IPv4 Range 聚合专门处理IPv类型的数据<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"aggs"</span> : &#123;</div><div class="line">        <span class="attr">"ip_ranges"</span> : &#123;</div><div class="line">            <span class="attr">"ip_range"</span> : &#123;</div><div class="line">                <span class="attr">"field"</span> : <span class="string">"ip"</span>,</div><div class="line">                <span class="attr">"ranges"</span> : [</div><div class="line">                    &#123; <span class="attr">"to"</span> : <span class="string">"10.0.0.5"</span> &#125;,</div><div class="line">                    &#123; <span class="attr">"from"</span> : <span class="string">"10.0.0.5"</span> &#125;</div><div class="line">                ]</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"aggregations"</span>: &#123;</div><div class="line">        <span class="attr">"ip_ranges"</span>: &#123;</div><div class="line">            <span class="attr">"buckets"</span> : [</div><div class="line">                &#123;</div><div class="line">                    <span class="attr">"to"</span>: <span class="number">167772165</span>,</div><div class="line">                    <span class="attr">"to_as_string"</span>: <span class="string">"10.0.0.5"</span>,</div><div class="line">                    <span class="attr">"doc_count"</span>: <span class="number">4</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                    <span class="attr">"from"</span>: <span class="number">167772165</span>,</div><div class="line">                    <span class="attr">"from_as_string"</span>: <span class="string">"10.0.0.5"</span>,</div><div class="line">                    <span class="attr">"doc_count"</span>: <span class="number">6</span></div><div class="line">                &#125;</div><div class="line">            ]</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>更多详见<a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.4/search-aggregations-bucket-iprange-aggregation.html" target="_blank" rel="external">官方文档</a></p>
<p>java使用示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">AggregationBuilder aggregation = AggregationBuilders</div><div class="line">                .ipRange(<span class="string">"agg"</span>)</div><div class="line">                .field(<span class="string">"ip"</span>)</div><div class="line">                .addUnboundedTo(<span class="string">"192.168.1.0"</span>)             <span class="comment">// from -infinity to 192.168.1.0 (excluded)</span></div><div class="line">                .addRange(<span class="string">"192.168.1.0"</span>, <span class="string">"192.168.2.0"</span>)    <span class="comment">// from 192.168.1.0 to 192.168.2.0 (excluded)</span></div><div class="line">                .addUnboundedFrom(<span class="string">"192.168.2.0"</span>);          <span class="comment">// from 192.168.2.0 to +infinity</span></div><div class="line">...</div><div class="line">Range agg = searchResponse.getAggregations().get(<span class="string">"agg"</span>);</div><div class="line"><span class="keyword">for</span> (Range.Bucket entry : agg.getBuckets()) &#123;</div><div class="line">    String key = entry.getKeyAsString();            <span class="comment">// Ip range as key</span></div><div class="line">    String fromAsString = entry.getFromAsString();  <span class="comment">// Ip bucket from as a String</span></div><div class="line">    String toAsString = entry.getToAsString();      <span class="comment">// Ip bucket to as a String</span></div><div class="line">    <span class="keyword">long</span> docCount = entry.getDocCount();            <span class="comment">// Doc count</span></div><div class="line"></div><div class="line">    logger.info(<span class="string">"key [&#123;&#125;], from [&#123;&#125;], to [&#123;&#125;], doc_count [&#123;&#125;]"</span>, key, fromAsString, toAsString, docCount);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">key [*-192.168.1.0], from [null], to [192.168.1.0], doc_count [13]</div><div class="line">key [192.168.1.0-192.168.2.0], from [192.168.1.0], to [192.168.2.0], doc_count [14]</div><div class="line">key [192.168.2.0-*], from [192.168.2.0], to [null], doc_count [23]</div></pre></td></tr></table></figure></p>
<h4 id="Histogram-聚合"><a href="#Histogram-聚合" class="headerlink" title="Histogram 聚合"></a>Histogram 聚合</h4><p>主要处理数值类型的多桶值聚合。Histogram聚合根据字段值动态创建固定数量(即interval)的桶。例如，一个文档有一个字段是商品的价格，在聚合执行过程中，我们配置聚合每隔5(假设表示5$)建立一个桶，每一个文档的价格都将被评估然后向下取整到最近的一个桶。加入一个商品的价格是32，它将被向下取整到30并将它放到key值是30的桶中，向下取整的方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">rem = value % <span class="function">interval</span></div><div class="line"><span class="title">if</span> <span class="params">(rem &lt; <span class="number">0</span>)</span> &#123;</div><div class="line">    rem += interval</div><div class="line">&#125;</div><div class="line">bucket_key = value - rem</div></pre></td></tr></table></figure></p>
<p>从上面的方法可以看出，interval的值必须是一个整数。</p>
<blockquote>
<p>注意：字段值在放进桶之前会被转换成整数，如果是一个负浮点数可能会被放进错误的桶中。例如在interval为2时-4.5会被转换成-4，所以应该用-4&lt;val&lt;-2的桶替代-6&lt;al&lt;-4的桶。</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"aggs"</span> : &#123;</div><div class="line">        <span class="attr">"prices"</span> : &#123;</div><div class="line">            <span class="attr">"histogram"</span> : &#123;</div><div class="line">                <span class="attr">"field"</span> : <span class="string">"price"</span>,</div><div class="line">                <span class="attr">"interval"</span> : <span class="number">50</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>返回结果<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"aggregations"</span>: &#123;</div><div class="line">        <span class="attr">"prices"</span> : &#123;</div><div class="line">            <span class="attr">"buckets"</span>: [</div><div class="line">                &#123;</div><div class="line">                    <span class="attr">"key"</span>: <span class="number">0</span>,</div><div class="line">                    <span class="attr">"doc_count"</span>: <span class="number">2</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                    <span class="attr">"key"</span>: <span class="number">50</span>,</div><div class="line">                    <span class="attr">"doc_count"</span>: <span class="number">4</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                    <span class="attr">"key"</span>: <span class="number">100</span>,</div><div class="line">                    <span class="attr">"doc_count"</span>: <span class="number">0</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                    <span class="attr">"key"</span>: <span class="number">150</span>,</div><div class="line">                    <span class="attr">"doc_count"</span>: <span class="number">3</span></div><div class="line">                &#125;</div><div class="line">            ]</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>min_doc_count</strong></p>
<p>在上面的结果中，没有商品的价格是在100-150区间的，默认情况下，聚合会用一个空桶填充这种“空隙”,如果需要返回的桶中有一个最小的数量，可以设置<strong>min_doc_count</strong>参数。<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"aggs"</span> : &#123;</div><div class="line">        <span class="attr">"prices"</span> : &#123;</div><div class="line">            <span class="attr">"histogram"</span> : &#123;</div><div class="line">                <span class="attr">"field"</span> : <span class="string">"price"</span>,</div><div class="line">                <span class="attr">"interval"</span> : <span class="number">50</span>,</div><div class="line">                <span class="attr">"min_doc_count"</span> : <span class="number">1</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"aggregations"</span>: &#123;</div><div class="line">        <span class="attr">"prices"</span> : &#123;</div><div class="line">            <span class="attr">"buckets"</span>: [</div><div class="line">                &#123;</div><div class="line">                    <span class="attr">"key"</span>: <span class="number">0</span>,</div><div class="line">                    <span class="attr">"doc_count"</span>: <span class="number">2</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                    <span class="attr">"key"</span>: <span class="number">50</span>,</div><div class="line">                    <span class="attr">"doc_count"</span>: <span class="number">4</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                    <span class="attr">"key"</span>: <span class="number">150</span>,</div><div class="line">                    <span class="attr">"doc_count"</span>: <span class="number">3</span></div><div class="line">                &#125;</div><div class="line">            ]</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>默认情况下，histogram聚合会返回所有数据范围的桶，文档的最小值会决定桶的key的最小值，文档的最大值会决定桶的key的最大值。常有的情况是我们会请求到空的桶，这常会令人困惑，特别是在聚合前数据被过滤的情况下。</p>
<p>假如我们从文档中取值是0-500的数据，设置interval为50分割数据，设置min_doc_count为0返回所有的空桶，假如所有的商品的最低价格是100，那么我们获得的第一个桶的key值是100，这会令人困惑，因为我希望获得0~100间的桶(即key=0和key=50)而实际上并没有。</p>
<p><strong>extended_bounds</strong></p>
<p>使用extended_bounds参数，能强制histogram聚合构建从min到max间的所有桶，即便是中间的某些桶没有任何数据。要使extended_bounds参数生效，必须设置min_doc_count为0。注意extended_bounds参数并不过滤任何桶，如果extended_bounds.min比文档的最小值要大，桶的最小key值仍由文档的最小值决定(这种情况同样适用于max)。如果需要过滤桶，可以使用query过滤器或是将histogram聚合嵌套到filter聚合中<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"query"</span> : &#123;</div><div class="line">        <span class="string">"constant_score"</span> : &#123; <span class="string">"filter"</span>: &#123; <span class="string">"range"</span> : &#123; <span class="string">"price"</span> : &#123; <span class="string">"to"</span> : <span class="string">"500"</span> &#125; &#125; &#125; &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"aggs"</span> : &#123;</div><div class="line">        <span class="string">"prices"</span> : &#123;</div><div class="line">            <span class="string">"histogram"</span> : &#123;</div><div class="line">                <span class="string">"field"</span> : <span class="string">"price"</span>,</div><div class="line">                <span class="string">"interval"</span> : <span class="number">50</span>,</div><div class="line">                <span class="string">"extended_bounds"</span> : &#123;</div><div class="line">                    <span class="string">"min"</span> : <span class="number">0</span>,</div><div class="line">                    <span class="string">"max"</span> : <span class="number">500</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>order</strong><br>默认情况下，桶的排列顺序是根据key值升序排列，如果需要自定义排列可以设置order参数<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"aggs"</span> : &#123;</div><div class="line">        <span class="string">"prices"</span> : &#123;</div><div class="line">            <span class="string">"histogram"</span> : &#123;</div><div class="line">                <span class="string">"field"</span> : <span class="string">"price"</span>,</div><div class="line">                <span class="string">"interval"</span> : <span class="number">50</span>,</div><div class="line">                <span class="string">"order"</span> : &#123; <span class="string">"_key"</span> : <span class="string">"desc"</span> &#125;   <span class="comment">//根据key降序</span></div><div class="line">                <span class="comment">//"order" : &#123; "_count" : "asc" &#125;    //根据文档数量升序</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>histogram聚合可以包含metrics子聚合，子聚合可以决定桶的排列顺序<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"aggs"</span> : &#123;</div><div class="line">        <span class="string">"prices"</span> : &#123;</div><div class="line">            <span class="string">"histogram"</span> : &#123;</div><div class="line">                <span class="string">"field"</span> : <span class="string">"price"</span>,</div><div class="line">                <span class="string">"interval"</span> : <span class="number">50</span>,</div><div class="line">                <span class="string">"order"</span> : &#123; <span class="string">"price_stats.min"</span> : <span class="string">"asc"</span> &#125; </div><div class="line">            &#125;,</div><div class="line">            <span class="string">"aggs"</span> : &#123;</div><div class="line">                <span class="string">"price_stats"</span> : &#123; <span class="string">"stats"</span> : &#123;&#125; &#125; <span class="comment">//可以不指定field字段，它将从父聚合继承</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>还可以使用层级更深的子聚合进行排序，只要这个子聚合是一个单值桶聚合或metrics聚合。如果是单值桶，最终histogram聚合会根据这个桶的文档数量(doc_count)排序，如果是包含多个度量值的metrics聚合(如states)，需要在路径中指定度量metrics名称,如果是单值的metrics聚合，将根据度量值排序。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"aggs"</span> : &#123;</div><div class="line">        <span class="string">"prices"</span> : &#123;</div><div class="line">            <span class="string">"histogram"</span> : &#123;</div><div class="line">                <span class="string">"field"</span> : <span class="string">"price"</span>,</div><div class="line">                <span class="string">"interval"</span> : <span class="number">50</span>,</div><div class="line">                <span class="string">"order"</span> : &#123; <span class="string">"promoted_products&gt;rating_stats.avg"</span> : <span class="string">"desc"</span> &#125; <span class="comment">//指定子聚路径和度量名(这里是avg)</span></div><div class="line">            &#125;,</div><div class="line">            <span class="string">"aggs"</span> : &#123;</div><div class="line">                <span class="string">"promoted_products"</span> : &#123;</div><div class="line">                    <span class="string">"filter"</span> : &#123; <span class="string">"term"</span> : &#123; <span class="string">"promoted"</span> : <span class="literal">true</span> &#125;&#125;,</div><div class="line">                    <span class="string">"aggs"</span> : &#123;</div><div class="line">                        <span class="string">"rating_stats"</span> : &#123; <span class="string">"stats"</span> : &#123; <span class="string">"field"</span> : <span class="string">"rating"</span> &#125;&#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的例子根据推广产品的平均价格降序排列。</p>
<p><strong>offset</strong></p>
<p>默认情况下桶的标记范围是从0开始，以interval逐步递增。例如interval为10，第一个桶(假设有值)是[0-9]，第二个是[10-19]，第三个是[20-29]，….。使用offset参数能够偏移桶的边界。举个例子，有10个文档，其值是5-14，interval为10，这会产生两个桶，每个桶有5个文档，如果设置offset为5，则只会产生一个包含所有文档的桶[5-14]。</p>
<p><strong>keyed 结果格式化</strong></p>
<p>默认情况下，结果会返回一个排好序的数组，可以设置keyed:true指定使用桶的key值作为返回结果的哈希键。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"aggs"</span> : &#123;</div><div class="line">        <span class="string">"prices"</span> : &#123;</div><div class="line">            <span class="string">"histogram"</span> : &#123;</div><div class="line">                <span class="string">"field"</span> : <span class="string">"price"</span>,</div><div class="line">                <span class="string">"interval"</span> : <span class="number">50</span>,</div><div class="line">                <span class="string">"keyed"</span> : <span class="literal">true</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"aggregations"</span>: &#123;</div><div class="line">        <span class="string">"prices"</span>: &#123;</div><div class="line">            <span class="string">"buckets"</span>: &#123;</div><div class="line">                <span class="string">"0"</span>: &#123;</div><div class="line">                    <span class="string">"key"</span>: <span class="number">0</span>,</div><div class="line">                    <span class="string">"doc_count"</span>: <span class="number">2</span></div><div class="line">                &#125;,</div><div class="line">                <span class="string">"50"</span>: &#123;</div><div class="line">                    <span class="string">"key"</span>: <span class="number">50</span>,</div><div class="line">                    <span class="string">"doc_count"</span>: <span class="number">4</span></div><div class="line">                &#125;,</div><div class="line">                <span class="string">"150"</span>: &#123;</div><div class="line">                    <span class="string">"key"</span>: <span class="number">150</span>,</div><div class="line">                    <span class="string">"doc_count"</span>: <span class="number">3</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>missing</strong></p>
<p>如果文档并没有值，missing参数决定了这个值该如何处理。默认下这个文档将被忽略。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"aggs"</span> : &#123;</div><div class="line">        <span class="string">"quantity"</span> : &#123;</div><div class="line">             <span class="string">"histogram"</span> : &#123;</div><div class="line">                 <span class="string">"field"</span> : <span class="string">"quantity"</span>,</div><div class="line">                 <span class="string">"interval"</span>: <span class="number">10</span>,</div><div class="line">                 <span class="string">"missing"</span>: <span class="number">0</span> </div><div class="line">             &#125;</div><div class="line">         &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果quantity字段没有值，它将被当做值为0（missing参数指定值）处理。</p>
<p>Java使用示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">AggregationBuilder aggregation = AggregationBuilders</div><div class="line">                .histogram(<span class="string">"agg"</span>)</div><div class="line">                .field(<span class="string">"height"</span>)</div><div class="line">                .interval(<span class="number">1</span>);</div><div class="line">...</div><div class="line">Histogram agg = sr.getAggregations().get(<span class="string">"agg"</span>);</div><div class="line"><span class="keyword">for</span> (Histogram.Bucket entry : agg.getBuckets()) &#123;</div><div class="line">    Long key = (Long) entry.getKey();       <span class="comment">// Key</span></div><div class="line">    <span class="keyword">long</span> docCount = entry.getDocCount();    <span class="comment">// Doc count</span></div><div class="line"></div><div class="line">    logger.info(<span class="string">"key [&#123;&#125;], doc_count [&#123;&#125;]"</span>, key, docCount);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Date-Histogram聚合"><a href="#Date-Histogram聚合" class="headerlink" title="Date Histogram聚合"></a>Date Histogram聚合</h4><p>类似于histogram聚合，它只能处理日期类型的字段值。因为在elasticsearch内部，日期类型数据被当做long类型处理，所以也可以用histogram聚合处理，但这会在精度上有所妥协，原因是基于时间的interval无法确定（思考下闰年的每月天数）。因此我们需要一种特殊的方式处理日期数据。从功能性的观点来看，date histogram聚合同普通的histogram聚合一样支持同样的特性。两者最大的不同是date histogram支持使用date/time表达式设置interval。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"aggs"</span> : &#123;</div><div class="line">        <span class="string">"articles_over_time"</span> : &#123;</div><div class="line">            <span class="string">"date_histogram"</span> : &#123;</div><div class="line">                <span class="string">"field"</span> : <span class="string">"date"</span>,</div><div class="line">                <span class="string">"interval"</span> : <span class="string">"month"</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以使用的interval有：year, quarter, month, week, day, hour, minute, second。</p>
<p>部分数值能够使用seconds, minutes, hours, days and weeks，如interval为1.5h<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"aggs"</span> : &#123;</div><div class="line">        <span class="string">"articles_over_time"</span> : &#123;</div><div class="line">            <span class="string">"date_histogram"</span> : &#123;</div><div class="line">                <span class="string">"field"</span> : <span class="string">"date"</span>,</div><div class="line">                <span class="string">"interval"</span> : <span class="string">"1.5h"</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>能够使用的缩写列表参考 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.4/common-options.html#time-units" target="_blank" rel="external">time-units</a>。目前有y(year),M(month),w(Week),d(day),h(hour),m(minute),s(second),ms(milli-second)。</p>
<p><strong>keys</strong></p>
<p>elasticsearch使用64 bit数字表示timestamp，这个timestamp也将作为桶的key，key_as_string表示使用format指定的格式转换后的值。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"aggs"</span> : &#123;</div><div class="line">        <span class="string">"articles_over_time"</span> : &#123;</div><div class="line">            <span class="string">"date_histogram"</span> : &#123;</div><div class="line">                <span class="string">"field"</span> : <span class="string">"date"</span>,</div><div class="line">                <span class="string">"interval"</span> : <span class="string">"1M"</span>,</div><div class="line">                <span class="string">"format"</span> : <span class="string">"yyyy-MM-dd"</span> </div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"aggregations"</span>: &#123;</div><div class="line">        <span class="string">"articles_over_time"</span>: &#123;</div><div class="line">            <span class="string">"buckets"</span>: [</div><div class="line">                &#123;</div><div class="line">                    <span class="string">"key_as_string"</span>: <span class="string">"2013-02-02"</span>,</div><div class="line">                    <span class="string">"key"</span>: <span class="number">1328140800000</span>,</div><div class="line">                    <span class="string">"doc_count"</span>: <span class="number">1</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                    <span class="string">"key_as_string"</span>: <span class="string">"2013-03-02"</span>,</div><div class="line">                    <span class="string">"key"</span>: <span class="number">1330646400000</span>,</div><div class="line">                    <span class="string">"doc_count"</span>: <span class="number">2</span></div><div class="line">                &#125;,</div><div class="line">                ...</div><div class="line">            ]</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>time zone</strong></p>
<p>具体参考文档 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.4/search-aggregations-bucket-datehistogram-aggregation.html#_time_zone" target="_blank" rel="external">Time Zone</a></p>
<p><strong>offset</strong></p>
<p>offset参数用来修改桶的起始范围，可以使用+，-符号，1h代表一小时，1M代表一个月。例如设置interval为day,每一个桶的起始范围是午夜到午夜，设置offset为+6h，修改桶的范围是6am到6am。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"aggs"</span>: &#123;</div><div class="line">    <span class="string">"by_day"</span>: &#123;</div><div class="line">      <span class="string">"date_histogram"</span>: &#123;</div><div class="line">        <span class="string">"field"</span>:     <span class="string">"date"</span>,</div><div class="line">        <span class="string">"interval"</span>:  <span class="string">"day"</span>,</div><div class="line">        <span class="string">"offset"</span>:    <span class="string">"+6h"</span></div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="string">"aggregations"</span>: &#123;</div><div class="line">  <span class="string">"by_day"</span>: &#123;</div><div class="line">    <span class="string">"buckets"</span>: [</div><div class="line">      &#123;</div><div class="line">        <span class="string">"key_as_string"</span>: <span class="string">"2015-09-30T06:00:00.000Z"</span>,</div><div class="line">        <span class="string">"key"</span>: <span class="number">1443592800000</span>,</div><div class="line">        <span class="string">"doc_count"</span>: <span class="number">1</span></div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="string">"key_as_string"</span>: <span class="string">"2015-10-01T06:00:00.000Z"</span>,</div><div class="line">        <span class="string">"key"</span>: <span class="number">1443679200000</span>,</div><div class="line">        <span class="string">"doc_count"</span>: <span class="number">1</span></div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>Scripts</strong></p>
<p>同histogram，文档参考 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.4/search-aggregations-bucket-datehistogram-aggregation.html#_scripts" target="_blank" rel="external">Scripts</a></p>
<p><strong>missing</strong></p>
<p>同histogram<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"aggs"</span> : &#123;</div><div class="line">        <span class="string">"publish_date"</span> : &#123;</div><div class="line">             <span class="string">"date_histogram"</span> : &#123;</div><div class="line">                 <span class="string">"field"</span> : <span class="string">"publish_date"</span>,</div><div class="line">                 <span class="string">"interval"</span>: <span class="string">"year"</span>,</div><div class="line">                 <span class="string">"missing"</span>: <span class="string">"2000-01-01"</span> </div><div class="line">             &#125;</div><div class="line">         &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>java使用示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">AggregationBuilder aggregation = AggregationBuilders</div><div class="line">                .dateHistogram(<span class="string">"agg"</span>)</div><div class="line">                .field(<span class="string">"dateOfBirth"</span>)</div><div class="line">                .interval(DateHistogramInterval.YEAR);  <span class="comment">//设置为year</span></div><div class="line">                <span class="comment">//.interval(DateHistogramInterval.days(10));    //设置为10day</span></div><div class="line">...</div><div class="line">Histogram agg = searchResponse.getAggregations().get(<span class="string">"agg"</span>);</div><div class="line"></div><div class="line"><span class="keyword">for</span> (Histogram.Bucket entry : agg.getBuckets()) &#123;</div><div class="line">    DateTime key = (DateTime) entry.getKey();    <span class="comment">// Key</span></div><div class="line">    String keyAsString = entry.getKeyAsString(); <span class="comment">// Key as String</span></div><div class="line">    <span class="keyword">long</span> docCount = entry.getDocCount();         <span class="comment">// Doc count</span></div><div class="line"></div><div class="line">    logger.info(<span class="string">"key [&#123;&#125;], date [&#123;&#125;], doc_count [&#123;&#125;]"</span>, keyAsString, key.getYear(), docCount);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">key [1942-01-01T00:00:00.000Z], date [1942], doc_count [1]</div><div class="line">key [1945-01-01T00:00:00.000Z], date [1945], doc_count [1]</div><div class="line">key [1946-01-01T00:00:00.000Z], date [1946], doc_count [1]</div><div class="line">...</div><div class="line">key [2005-01-01T00:00:00.000Z], date [2005], doc_count [1]</div><div class="line">key [2007-01-01T00:00:00.000Z], date [2007], doc_count [2]</div><div class="line">key [2008-01-01T00:00:00.000Z], date [2008], doc_count [3]</div></pre></td></tr></table></figure></p>
<h4 id="Geo-Distance聚合"><a href="#Geo-Distance聚合" class="headerlink" title="Geo Distance聚合"></a>Geo Distance聚合</h4><p>一个多桶值聚合，处理geo_point数据，从概念上类类似于range聚合。用户定义一个圆点并设置桶的距离范围，聚合会计算文档的geo_point点到圆点间的距离然后决定应该归属到哪一个桶。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"aggs"</span> : &#123;</div><div class="line">        <span class="string">"rings_around_amsterdam"</span> : &#123;</div><div class="line">            <span class="string">"geo_distance"</span> : &#123;</div><div class="line">                <span class="string">"field"</span> : <span class="string">"location"</span>,</div><div class="line">                <span class="string">"origin"</span> : <span class="string">"52.3760, 4.894"</span>,</div><div class="line">                <span class="string">"ranges"</span> : [</div><div class="line">                    &#123; <span class="string">"to"</span> : <span class="number">100</span> &#125;,</div><div class="line">                    &#123; <span class="string">"from"</span> : <span class="number">100</span>, <span class="string">"to"</span> : <span class="number">300</span> &#125;,</div><div class="line">                    &#123; <span class="string">"from"</span> : <span class="number">300</span> &#125;</div><div class="line">                ]</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回数据<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"aggregations"</span>: &#123;</div><div class="line">        <span class="string">"rings"</span> : &#123;</div><div class="line">            <span class="string">"buckets"</span>: [</div><div class="line">                &#123;</div><div class="line">                    <span class="string">"key"</span>: <span class="string">"*-100.0"</span>,</div><div class="line">                    <span class="string">"from"</span>: <span class="number">0</span>,</div><div class="line">                    <span class="string">"to"</span>: <span class="number">100.0</span>,</div><div class="line">                    <span class="string">"doc_count"</span>: <span class="number">3</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                    <span class="string">"key"</span>: <span class="string">"100.0-300.0"</span>,</div><div class="line">                    <span class="string">"from"</span>: <span class="number">100.0</span>,</div><div class="line">                    <span class="string">"to"</span>: <span class="number">300.0</span>,</div><div class="line">                    <span class="string">"doc_count"</span>: <span class="number">1</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                    <span class="string">"key"</span>: <span class="string">"300.0-*"</span>,</div><div class="line">                    <span class="string">"from"</span>: <span class="number">300.0</span>,</div><div class="line">                    <span class="string">"doc_count"</span>: <span class="number">7</span></div><div class="line">                &#125;</div><div class="line">            ]</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>指定的字段必须是geo_point类型，也可以是数组类型(数组值必须是get_point)类型，如果是这种情况，数组中的每一个值都将被计算，圆点能够接受以下<a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.4/geo-point.html" target="_blank" rel="external">geo_point type</a></p>
<ul>
<li>对象格式：<code>{ &quot;lat&quot; : 52.3760, &quot;lon&quot; : 4.894 }</code>，这也是最安全的方式</li>
<li>字符串格式：<code>&quot;52.3760, 4.894&quot;</code>，第一个数字是lan，第二个数字是lon</li>
<li>数组格式：<code>[4.894, 52.3760]</code>，第一个时lon，第二个是lan，==注意与上面两种方式的不同==。</li>
</ul>
<p>默认距离单位是m(米)，也能接受mi(英里)，in (英寸), yd (码), km (千米), cm (厘米), mm (毫米)。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"aggs"</span> : &#123;</div><div class="line">        <span class="string">"rings"</span> : &#123;</div><div class="line">            <span class="string">"geo_distance"</span> : &#123;</div><div class="line">                <span class="string">"field"</span> : <span class="string">"location"</span>,</div><div class="line">                <span class="string">"origin"</span> : <span class="string">"52.3760, 4.894"</span>,</div><div class="line">                <span class="string">"unit"</span> : <span class="string">"mi"</span>,      <span class="comment">//设置距离单位为英里</span></div><div class="line">                <span class="string">"ranges"</span> : [</div><div class="line">                    &#123; <span class="string">"to"</span> : <span class="number">100</span> &#125;,</div><div class="line">                    &#123; <span class="string">"from"</span> : <span class="number">100</span>, <span class="string">"to"</span> : <span class="number">300</span> &#125;,</div><div class="line">                    &#123; <span class="string">"from"</span> : <span class="number">300</span> &#125;</div><div class="line">                ]</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>distance_type</strong></p>
<p>Geo Distance聚合有三种计算距离的方式，通过distance_type参数设置</p>
<ul>
<li>sloppy_arc：默认方式，速度较快，精度稍差</li>
<li>arc：速度最慢，精度最高。</li>
<li>plane：速度最快，精度最低。推荐在小的地域使用，如城市或国家。在跨洲计算时误差很大<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"aggs"</span> : &#123;</div><div class="line">        <span class="string">"rings"</span> : &#123;</div><div class="line">            <span class="string">"geo_distance"</span> : &#123;</div><div class="line">                <span class="string">"field"</span> : <span class="string">"location"</span>,</div><div class="line">                <span class="string">"origin"</span> : <span class="string">"52.3760, 4.894"</span>,</div><div class="line">                <span class="string">"distance_type"</span> : <span class="string">"plane"</span>,</div><div class="line">                <span class="string">"ranges"</span> : [</div><div class="line">                    &#123; <span class="string">"to"</span> : <span class="number">100</span> &#125;,</div><div class="line">                    &#123; <span class="string">"from"</span> : <span class="number">100</span>, <span class="string">"to"</span> : <span class="number">300</span> &#125;,</div><div class="line">                    &#123; <span class="string">"from"</span> : <span class="number">300</span> &#125;</div><div class="line">                ]</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>java使用示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">AggregationBuilder aggregation = AggregationBuilders</div><div class="line">                .geoDistance(<span class="string">"agg"</span>)</div><div class="line">                .field(<span class="string">"address.location"</span>)</div><div class="line">                .point(<span class="keyword">new</span> GeoPoint(<span class="number">48.84237171118314</span>,<span class="number">2.33320027692004</span>))</div><div class="line">                .unit(DistanceUnit.KILOMETERS)</div><div class="line">                .addUnboundedTo(<span class="number">3.0</span>)</div><div class="line">                .addRange(<span class="number">3.0</span>, <span class="number">10.0</span>)</div><div class="line">                .addRange(<span class="number">10.0</span>, <span class="number">500.0</span>);</div><div class="line">...</div><div class="line">Range agg = sr.getAggregations().get(<span class="string">"agg"</span>);</div><div class="line"><span class="keyword">for</span> (Range.Bucket entry : agg.getBuckets()) &#123;</div><div class="line">    String key = entry.getKeyAsString();    <span class="comment">// key as String</span></div><div class="line">    Number from = (Number) entry.getFrom(); <span class="comment">// bucket from value</span></div><div class="line">    Number to = (Number) entry.getTo();     <span class="comment">// bucket to value</span></div><div class="line">    <span class="keyword">long</span> docCount = entry.getDocCount();    <span class="comment">// Doc count</span></div><div class="line"></div><div class="line">    logger.info(<span class="string">"key [&#123;&#125;], from [&#123;&#125;], to [&#123;&#125;], doc_count [&#123;&#125;]"</span>, key, from, to, docCount);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印结果如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">key [*-3.0], from [0.0], to [3.0], doc_count [161]</div><div class="line">key [3.0-10.0], from [3.0], to [10.0], doc_count [460]</div><div class="line">key [10.0-500.0], from [10.0], to [500.0], doc_count [4925]</div></pre></td></tr></table></figure></p>
<h4 id="GeoHash-grid-聚合"><a href="#GeoHash-grid-聚合" class="headerlink" title="GeoHash grid 聚合"></a>GeoHash grid 聚合</h4><p>一个多值桶聚合，将geo_point数据代表的地理点根据设定的精密度划分成一个网格，每一个桶代表一个单元格。单元格的精密度用<a href="https://en.wikipedia.org/wiki/Geohash" target="_blank" rel="external">geohash</a>表示。精密度越高，每个单元格代表的区域越小。GeoHash grid 聚合采用的geohash精密度用1-12表示，数值越大，精密度越高。</p>
<blockquote>
<p>注意：12级的最高精密度下，每个单元格代表的实际区域不到一平方米，因此高精密度的数据请求会过多的消耗内存，在请求高精密度的数据前请尽量使用过滤聚合成小的地理单位。</p>
</blockquote>
<p>指定的字段必须是geo_point类型，也可以是数组类型(数组值必须是get_point)类型，如果是这种情况，数组中的每一个值都将被计算。</p>
<p>低密度示例<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"aggregations"</span> : &#123;</div><div class="line">        <span class="string">"myLarge-GrainGeoHashGrid"</span> : &#123;</div><div class="line">            <span class="string">"geohash_grid"</span> : &#123;</div><div class="line">                <span class="string">"field"</span> : <span class="string">"location"</span>,</div><div class="line">                <span class="string">"precision"</span> : <span class="number">3</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回结果<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"aggregations"</span>: &#123;</div><div class="line">        <span class="string">"myLarge-GrainGeoHashGrid"</span>: &#123;</div><div class="line">            <span class="string">"buckets"</span>: [</div><div class="line">                &#123;</div><div class="line">                    <span class="string">"key"</span>: <span class="string">"svz"</span>,</div><div class="line">                    <span class="string">"doc_count"</span>: <span class="number">10964</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                    <span class="string">"key"</span>: <span class="string">"sv8"</span>,</div><div class="line">                    <span class="string">"doc_count"</span>: <span class="number">3198</span></div><div class="line">                &#125;</div><div class="line">            ]</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>高精密度示例。在高精密度聚合前，使用了<a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.4/query-dsl-geo-bounding-box-query.html" target="_blank" rel="external">geo_bounding_box</a>过滤器将计算的地理区域变小，否则可能会创建数百万的桶。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"aggregations"</span> : &#123;</div><div class="line">        <span class="string">"zoomedInView"</span> : &#123;</div><div class="line">            <span class="string">"filter"</span> : &#123;</div><div class="line">                <span class="string">"geo_bounding_box"</span> : &#123;</div><div class="line">                    <span class="string">"location"</span> : &#123;</div><div class="line">                        <span class="string">"top_left"</span> : <span class="string">"51.73, 0.9"</span>,</div><div class="line">                        <span class="string">"bottom_right"</span> : <span class="string">"51.55, 1.1"</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;,</div><div class="line">            <span class="string">"aggregations"</span>:&#123;</div><div class="line">                <span class="string">"zoom1"</span>:&#123;</div><div class="line">                    <span class="string">"geohash_grid"</span> : &#123;</div><div class="line">                        <span class="string">"field"</span>:<span class="string">"location"</span>,</div><div class="line">                        <span class="string">"precision"</span>:<span class="number">8</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>精密度表如下：</p>
<table>
<thead>
<tr>
<th>等级</th>
<th>地理区域</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>5,009.4km x 4,992.6km</td>
</tr>
<tr>
<td>2</td>
<td>1,252.3km x 624.1km</td>
</tr>
<tr>
<td>3</td>
<td>156.5km x 156km</td>
</tr>
<tr>
<td>4</td>
<td>39.1km x 19.5km</td>
</tr>
<tr>
<td>5</td>
<td>4.9km x 4.9km</td>
</tr>
<tr>
<td>6</td>
<td>1.2km x 609.4m</td>
</tr>
<tr>
<td>7</td>
<td>152.9m x 152.4m</td>
</tr>
<tr>
<td>8</td>
<td>38.2m x 19m</td>
</tr>
<tr>
<td>9</td>
<td>4.8m x 4.8m</td>
</tr>
<tr>
<td>10</td>
<td>1.2m x 59.5cm</td>
</tr>
<tr>
<td>11</td>
<td>14.9cm x 14.9cm</td>
</tr>
<tr>
<td>12</td>
<td>3.7cm x 1.9cm</td>
</tr>
</tbody>
</table>
<p><strong>选项</strong></p>
<ul>
<li>field：必填，geo_point数据的字段名</li>
<li>precision：可选，默认5，精密度等级</li>
<li>size：可选，默认10000，返回的桶的数量。桶包含的文档数越多优先权越高。</li>
<li>shard_size：可选，默认返回数量是max(10,size*切片数量)，每个切片返回的桶的数量。</li>
</ul>
<p>Java使用示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">AggregationBuilder aggregation = AggregationBuilders</div><div class="line">                .geohashGrid(<span class="string">"agg"</span>)</div><div class="line">                .field(<span class="string">"address.location"</span>)</div><div class="line">                .precision(<span class="number">4</span>);</div><div class="line">...</div><div class="line">GeoHashGrid agg = searchResponse.getAggregations().get(<span class="string">"agg"</span>);</div><div class="line"></div><div class="line"><span class="keyword">for</span> (GeoHashGrid.Bucket entry : agg.getBuckets()) &#123;</div><div class="line">    String keyAsString = entry.getKeyAsString(); <span class="comment">// key as String</span></div><div class="line">    GeoPoint key = (GeoPoint) entry.getKey();    <span class="comment">// key as geo point</span></div><div class="line">    <span class="keyword">long</span> docCount = entry.getDocCount();         <span class="comment">// Doc count</span></div><div class="line"></div><div class="line">    logger.info(<span class="string">"key [&#123;&#125;], point &#123;&#125;, doc_count [&#123;&#125;]"</span>, keyAsString, key, docCount);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>打印結果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">key [gbqu], point [47.197265625, -1.58203125], doc_count [1282]</div><div class="line">key [gbvn], point [50.361328125, -4.04296875], doc_count [1248]</div><div class="line">key [u1j0], point [50.712890625, 7.20703125], doc_count [1156]</div><div class="line">key [u0j2], point [45.087890625, 7.55859375], doc_count [1138]</div><div class="line">...</div></pre></td></tr></table></figure></p>

                    
                        
                    
                    
                        <p>
                            <a href="/2017/06/16/elasticsearh文档整理-聚合/#post-footer" class="postShorten-excerpt_link link">
                                注释和共享
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-right" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2017/06/14/elasticsearch安装与集成/">
                            elasticsearch安装与集成
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2017-06-14T17:50:59+08:00">
	
		    6月 14, 2017
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/大数据/">大数据</a>, <a class="category-link" href="/categories/大数据/elasticsearch/">elasticsearch</a>


    
</div>

            </div>
            
                <div class="postShorten-excerpt" itemprop="articleBody">
                    <p><em>elasticsearch版本 2.4.5</em></p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ul>
<li>下载es并解压</li>
<li><p>修改config目录下elasticsearch.yml文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cluster.name: my-es</div><div class="line">node.name: node-1</div><div class="line">network.host: 192.168.70.128</div><div class="line">http.port: 9200</div></pre></td></tr></table></figure>
</li>
<li><p>在elasticsearch根目录下创建data目录</p>
</li>
</ul>
<p>elasticsearch不允许使用root账户启动，需要添加一个新账户<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">useradd esroot #创建用户</div><div class="line">passwd esroot #设置密码，连续输入两次</div><div class="line">groupadd es #添加分组</div><div class="line">usermod -G esroot es #如果报用户“es”不存在，是因为服务器版本问题，改成usermod -G es esroot</div><div class="line">chown -R esroot.es * #在elasticsearch根目录下执行，给用户赋权</div><div class="line">su esroot #切换用户</div></pre></td></tr></table></figure></p>
                    
                        <a href="/2017/06/14/elasticsearch安装与集成/" class="postShorten-excerpt_link link">
                            阅读全文
                        </a>
                        
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-right" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/2017/06/13/elasticserch-sql和mybatis整合记录/">
                            elasticserch-sql和mybatis整合记录
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2017-06-13T18:03:00+08:00">
	
		    6月 13, 2017
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/大数据/">大数据</a>, <a class="category-link" href="/categories/大数据/elasticsearch/">elasticsearch</a>


    
</div>

            </div>
            
                <div class="postShorten-excerpt" itemprop="articleBody">
                    <p>[TOC]</p>
<h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><p>elasticearch即es本身没有JDBC驱动，是无法像mybatis管理数据库连接池进行数据库操作的。在<a href="https://github.com/NLPchina/elasticsearch-sql" target="_blank" rel="external">GitHub</a>上有个elasticsearch-sql的项目，作为es的插件后能够使用sql对es进行数据检索，项目提供了一个支持JDBC的实验特性，在druid的基础上实现了部分JDBC的功能。GitHub上目前仅给出了一个使用用例</p>
<blockquote>
<p>2017-8-12修改：<br>重写了该项目，分离了Druid连接池，不再限制使用Druid，添加了Driver，项目已共享至GitHub <a href="https://github.com/zhanyingf15/elasticsearch-jdbc" target="_blank" rel="external">elasticsearch-jdbc</a>，欢迎fork</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Properties properties = <span class="keyword">new</span> Properties();</div><div class="line">properties.put(<span class="string">"url"</span>, <span class="string">"jdbc:elasticsearch://192.168.70.128:9300/"</span>);</div><div class="line">DruidDataSource dds = (DruidDataSource) ElasticSearchDruidDataSourceFactory.createDataSource(properties);</div><div class="line">Connection connection = dds.getConnection();</div><div class="line">PreparedStatement ps = connection.prepareStatement(<span class="string">"SELECT  * from  radiott"</span>);</div><div class="line">ResultSet resultSet = ps.executeQuery();</div><div class="line">List&lt;String&gt; result = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line"><span class="keyword">while</span> (resultSet.next()) &#123;</div><div class="line">    System.out.println(resultSet.getString(<span class="string">"id"</span>) + <span class="string">","</span> + resultSet.getString(<span class="string">"name"</span>));</div><div class="line">&#125;</div><div class="line">ps.close();</div><div class="line">connection.close();</div><div class="line">dds.close();</div></pre></td></tr></table></figure>
                    
                        <a href="/2017/06/13/elasticserch-sql和mybatis整合记录/" class="postShorten-excerpt_link link">
                            阅读全文
                        </a>
                        
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
        <li class="pagination-number">第 1 页 共 1 页</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2017 忘语. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/me.jpg"/>
        
            <h4 id="about-card-name">忘语</h4>
        
            <h5 id="about-card-bio"><h3 id="热爱生活-享受code"><a href="#热爱生活-享受code" class="headerlink" title="热爱生活,享受code"></a>热爱生活,享受code</h3></h5>
        
        
            <h5 id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <h4 id="一名虔诚的程序猿"><a href="#一名虔诚的程序猿" class="headerlink" title="一名虔诚的程序猿"></a>一名虔诚的程序猿</h4>
            </h5>
        
        
    </div>
</div>

        
<div id="cover" style="background-image:url('http://ww1.sinaimg.cn/large/86135ceagy1fc0pkcjc5oj21hc0u0gun.jpg');"></div>
    </body>
    <!--SCRIPTS-->
<script src="/assets/js/script-i4qo6jx6jji9fg0dftpya6ivemizsbow4fhow76d8dwpm7m1wbvi378ssumx.min.js"></script>
<!--SCRIPTS END-->



</html>
